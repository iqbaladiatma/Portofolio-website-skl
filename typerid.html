<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TyperID v14.5 - The Ultimate Training Hub</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⌨️</text></svg>">

    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Font Inter & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Memuat Three.js untuk Latar Belakang 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* General Styling */
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .view { display: none; }
        .view.active { display: flex; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Tabs & Buttons */
        .tab-nav { transition: opacity 0.3s, visibility 0.3s; }
        .tab-nav.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .tab.active, .mode-btn.active, .modal-tab.active { background-color: #06b6d4; color: white; box-shadow: 0 0 15px rgba(6, 182, 212, 0.5); }
        .tab:not(.active), .modal-tab:not(.active) { background-color: #374151; }
        .mode-btn:not(.active) { background-color: #4b5563; }

        /* Typing Area */
        .cursor { animation: blink 1s infinite; }
        @keyframes blink { 50% { border-left-color: #a3e635; } }
        .char-span { transition: color 0.2s, background-color 0.2s; }
        .char-correct { color: #4ade80; }
        .char-incorrect { color: #f87171; background-color: rgba(239, 68, 68, 0.2); border-radius: 2px; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
        .shake-error { animation: shake 0.2s ease-in-out; }
        
        /* Progress Bar Animation */
        .progress-bar-inner { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Effects */
        .ripple { position: absolute; border-radius: 50%; background-color: rgba(163, 230, 53, 0.5); transform: scale(0); animation: ripple 0.6s linear; }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* Role Tags Style */
        .role-tag {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            position: relative;
            overflow: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }
        
        .admin-tag { background: linear-gradient(90deg, #facc15, #fb923c, #facc15); background-size: 200% 200%; color: #111827; animation: gradient-animation 4s ease infinite; }
        .user-tag { background-color: #4b5563; color: #d1d5db; }

        /* --- NEW & IMPROVED: Developer Tag Shimmer --- */
        @keyframes dev-glow-red {
            0%, 100% { box-shadow: 0 0 6px #ef4444, 0 0 12px #ef4444; }
            50% { box-shadow: 0 0 12px #f87171, 0 0 20px #f87171; }
        }
        @keyframes new-shimmer {
            0% { background-position: -150% center; }
            100% { background-position: 150% center; }
        }
        .dev-tag {
            background-color: #dc2626;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.6);
            animation: dev-glow-red 3s ease-in-out infinite;
            background-image: linear-gradient(
                100deg,
                transparent 20%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 80%
            );
            background-size: 200% 100%;
            background-repeat: no-repeat;
            animation: dev-glow-red 3s ease-in-out infinite,
                       new-shimmer 2.5s infinite linear 1s;
        }
        
        /* Overlays & Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(5px); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; padding: 1rem; }
        .modal-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 100%; max-width: 500px; }
        #countdown-text { font-size: 10rem; font-weight: 900; color: white; transition: transform 0.2s, opacity 0.2s; }
        .countdown-zoom { animation: countdown-zoom-anim 1s ease-in-out; }
        @keyframes countdown-zoom-anim {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        #app-loader .spinner { width: 60px; height: 60px; border: 5px solid #4b5563; border-top-color: #22d3ee; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toasts */
        .toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .toast { padding: 14px 22px; border-radius: 8px; color: white; font-weight: 500; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: toast-in 0.5s forwards, toast-out 0.5s forwards 2.5s; opacity: 0; transform: translateY(20px); }
        .toast.info { background-color: #06b6d4; }
        .toast.error { background-color: #ef4444; }
        .special-toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 500; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: special-toast-in 0.7s cubic-bezier(0.25, 1, 0.5, 1) forwards, toast-out 0.5s forwards 7.5s; opacity: 0; transform: translateY(20px); border-left: 5px solid; max-width: 400px; text-align: center; }
        .special-toast.dev-message { background: linear-gradient(to right, #1f2937, #374151); border-color: #ef4444; }
        .special-toast.admin-message { background: linear-gradient(to right, #1f2937, #374151); border-color: #facc15; }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-out { to { opacity: 0; transform: translateY(20px); } }
        @keyframes special-toast-in { to { opacity: 1; transform: translateY(0); } }

        /* Global Chat */
        #global-chat-view { height: calc(100vh - 250px); max-height: 600px; }
        .chat-bubble { max-width: 75%; padding: 0.75rem 1rem; word-wrap: break-word; position: relative; }
        .chat-bubble.user-bubble { background-color: #374151; border-radius: 1.25rem; border-bottom-left-radius: 0.25rem; }
        .chat-bubble.my-bubble { background-color: #06b6d4; border-radius: 1.25rem; border-bottom-right-radius: 0.25rem; }
        .chat-bubble.admin-bubble { background: linear-gradient(135deg, #facc15, #fb923c); color: #1f2937; border-radius: 1.25rem; border-bottom-left-radius: 0.25rem; }
        .chat-bubble.my-admin-bubble { background: linear-gradient(135deg, #facc15, #fb923c); color: #1f2937; border-radius: 1.25rem; border-bottom-right-radius: 0.25rem; }
        
        /* Enhanced Developer Chat Bubble (Cloud Shape) */
        .dev-bubble-base {
            background: linear-gradient(135deg, #4c0519, #111827);
            color: #fecaca;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            border: 1px solid #ef4444;
        }
        .chat-bubble.dev-bubble {
            border-radius: 30px 30px 30px 5px;
        }
        .chat-bubble.my-dev-bubble {
            border-radius: 30px 30px 5px 30px;
        }

        .reply-content { background-color: rgba(0,0,0,0.2); padding: 0.25rem 0.5rem; margin-bottom: 0.25rem; border-left: 3px solid #06b6d4; border-radius: 4px; font-size: 0.8rem; opacity: 0.8; }
        
        /* Chat Animations & Interactions */
        @keyframes new-message-anim {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .new-message {
            animation: new-message-anim 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #typing-indicator {
            height: 24px;
            padding: 0 1rem;
            color: #9ca3af;
            font-style: italic;
            font-size: 0.9rem;
            transition: opacity 0.3s;
        }
        .message-options { position: absolute; top: -10px; background-color: #111827; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); display: flex; gap: 4px; padding: 4px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 10; }
        .my-message .message-options { right: 0; }
        .other-message .message-options { left: 0; }
        .chat-message-container:hover .message-options { opacity: 1; visibility: visible; top: -30px; }
        .option-btn { background: none; border: none; color: #d1d5db; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .option-btn:hover { background-color: #374151; }
        .reactions-container { display: flex; gap: 4px; margin-top: 6px; }
        .reaction-pill { background-color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; }
        .reaction-pill.reacted { background-color: #0e7490; border-color: #06b6d4; }
        .reaction-picker { position: absolute; top: -40px; background-color: #1f2937; border: 1px solid #374151; border-radius: 8px; padding: 4px; display: flex; gap: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 20; }
        .my-message .reaction-picker { right: 20px; }
        .other-message .reaction-picker { left: 20px; }

        /* Developer Cheat Button */
        #dev-cheat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10001;
            padding: 8px 16px;
            background: linear-gradient(90deg, #ef4444, #f87171);
            color: white;
            font-weight: bold;
            border-radius: 8px;
            border: 1px solid #dc2626;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
            transition: all 0.3s ease;
        }
        #dev-cheat-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.8);
        }
        #dev-cheat-btn.active {
            background: linear-gradient(90deg, #16a34a, #22c55e);
            border-color: #15803d;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6);
        }
        #dev-cheat-btn:disabled {
            background: #4b5563;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            border-color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-900 text-slate-300 flex items-center justify-center min-h-screen p-4 antialiased">
    <canvas id="bg-canvas"></canvas>

    <!-- Overlays -->
    <div id="countdown-overlay" class="overlay"> <span id="countdown-text">3</span> </div>
    <div id="app-loader" class="overlay flex-col"> <div class="spinner"></div> <p id="loader-text" class="text-white text-xl mt-4 font-semibold"></p> </div>
    <div id="banned-overlay" class="overlay"> <h1 class="text-5xl font-bold text-red-500">ANDA TELAH DIBANNED</h1> <p class="text-slate-300 mt-2">Anda akan keluar secara otomatis dalam <span id="ban-timer">5</span> detik.</p> </div>
    
    <!-- Modals -->
    <div id="users-modal" class="overlay">
        <div class="modal-card flex flex-col h-full max-h-[80vh]">
            <div class="flex justify-between items-center p-4 border-b border-gray-600">
                <h2 class="text-xl font-bold text-cyan-400">Panel Pengguna</h2>
                <button id="close-users-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex p-1 bg-gray-900/50">
                <button id="online-users-tab" class="modal-tab w-full py-2 rounded-md">Online (<span id="online-user-count">0</span>)</button>
                <button id="banned-users-tab" class="modal-tab w-full py-2 rounded-md">Banned (<span id="banned-user-count">0</span>)</button>
            </div>
            <div id="users-list-container" class="p-4 overflow-y-auto flex-grow"></div>
            <div id="banned-list-container" class="p-4 overflow-y-auto flex-grow hidden"></div>
            <div id="users-modal-permission-denied" class="p-8 text-center text-slate-400 hidden">
                Maaf kamu bukan Admin atau Developer, jadi kamu tidak bisa mengakses bagian ini. Kamu bisa minta tolong ke Rakhan jika mau menjadi Admin atau Developer.
            </div>
        </div>
    </div>
    <div id="send-message-modal" class="overlay">
        <div class="modal-card p-6 flex flex-col gap-4">
            <h2 class="text-xl font-bold text-cyan-400">Kirim Pesan ke <span id="message-recipient-name"></span></h2>
            <textarea id="message-input" class="w-full bg-gray-700 text-white p-2 rounded-md h-24 resize-none" placeholder="Tulis pesan Anda..."></textarea>
            <div class="flex gap-4">
                <button id="cancel-send-message-btn" class="w-full py-2 bg-gray-600 rounded-md">Batal</button>
                <button id="confirm-send-message-btn" class="w-full py-2 bg-cyan-500 rounded-md">Kirim</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-5xl mx-auto z-10 h-screen overflow-y-auto pb-16 scrollbar-hide">
        <!-- Header -->
        <header class="text-center my-8">
             <h1 class="text-5xl md:text-6xl font-black text-white tracking-tighter">
                <svg width="300" height="70" viewBox="0 0 300 70" class="inline-block">
                    <text x="0" y="55" font-family="Inter, sans-serif" font-weight="900" font-size="60" fill="white">Typer</text>
                    <text x="175" y="55" font-family="Inter, sans-serif" font-weight="900" font-size="60" fill="#22d3ee">ID</text>
                    <text x="245" y="35" font-family="Inter, sans-serif" font-weight="700" font-size="20" fill="#a3e635">v14.5</text>
                </svg>
            </h1>
            <p class="text-slate-400 mt-1">The Ultimate Typing & CPS Training Hub</p>
            <div id="role-notice-container" class="mt-2"></div>
            <div id="admin-panel-button-container" class="mt-4 flex justify-center"></div>
        </header>

        <!-- ########## NAME ENTRY VIEW ########## -->
        <div id="name-entry-view" class="view active flex-col items-center gap-6 p-8 bg-gray-800/80 backdrop-blur-sm rounded-lg border border-gray-700 max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-cyan-400">Selamat Datang!</h2>
            <p class="text-center text-slate-400">Masukkan nama panggilan Anda untuk bermain.</p>
            <input type="text" id="player-name-input" placeholder="Nama Anda..." maxlength="45" class="w-full text-center bg-gray-700 text-white px-4 py-3 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <button id="enter-app-btn" class="w-full px-6 py-3 bg-lime-500 text-gray-900 font-bold rounded-md hover:bg-lime-600 transition-colors text-lg">Masuk</button>
        </div>

        <!-- ########## MAIN APP VIEW ########## -->
        <div id="main-app-view" class="view flex-col">
            <div id="main-tab-nav" class="tab-nav flex justify-center gap-2 mb-6">
                <button id="solo-tab-btn" class="tab active px-6 py-2 font-bold rounded-md transition-all duration-300 flex items-center gap-2"><i class="fa-solid fa-user"></i> Solo</button>
                <button id="practical-tab-btn" class="tab px-6 py-2 font-bold rounded-md transition-all duration-300 flex items-center gap-2"><i class="fa-solid fa-dumbbell"></i> Practical</button>
                <button id="online-tab-btn" class="tab px-6 py-2 font-bold rounded-md transition-all duration-300 flex items-center gap-2"><i class="fa-solid fa-users"></i> Online</button>
                <button id="global-chat-tab-btn" class="tab px-6 py-2 font-bold rounded-md transition-all duration-300 flex items-center gap-2"><i class="fa-solid fa-globe"></i> Global Chat</button>
            </div>
            <main>
                <div id="solo-tester" class="view active flex-col gap-6"></div>
                <div id="practical-tester" class="view flex-col gap-6"></div>
                <div id="online-tester" class="view flex-col gap-6">
                    <div id="lobby-view" class="view active flex-col items-center gap-6 p-8 bg-gray-800/80 backdrop-blur-sm rounded-lg border border-gray-700">
                        <h2 class="text-2xl font-bold text-cyan-400">Lobby Pertandingan Online</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl">
                            <button id="create-wpm-match-btn" class="px-6 py-3 bg-cyan-500 text-white font-bold rounded-md hover:bg-cyan-600 transition-colors text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-keyboard"></i> Buat Match WPM</button>
                            <button id="create-cps-match-btn" class="px-6 py-3 bg-cyan-500 text-white font-bold rounded-md hover:bg-cyan-600 transition-colors text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-computer-mouse"></i> Buat Match CPS</button>
                        </div>
                        <button id="join-random-match-btn" class="w-full max-w-2xl px-6 py-3 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition-colors text-lg flex items-center justify-center gap-2"><i class="fa-solid fa-dice"></i> Gabung Match Acak</button>
                        <div class="text-center text-slate-400">atau</div>
                        <div class="w-full max-w-sm flex flex-col gap-2">
                            <input type="text" id="join-match-input" placeholder="Masukkan Kode Pertandingan" class="text-center bg-gray-700 text-white px-4 py-3 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-400">
                            <button id="join-match-btn" class="w-full px-6 py-3 bg-lime-500 text-gray-900 font-bold rounded-md hover:bg-lime-600 transition-colors text-lg">Gabung Dengan Kode</button>
                        </div>
                    </div>
                    <div id="match-room-view" class="view flex-col gap-6"></div>
                </div>
                <div id="global-chat-view" class="view flex-col gap-4 bg-gray-800/80 backdrop-blur-sm rounded-lg border border-gray-700 p-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-cyan-400 text-center">Global Chat</h2>
                        <div id="chat-status-indicator" class="text-xs text-slate-400"></div>
                    </div>
                    <div id="chat-messages-container" class="flex-grow overflow-y-auto scrollbar-hide flex flex-col-reverse">
                        <ul id="chat-messages-list" class="flex flex-col gap-4 p-2">
                            <!-- Messages will be injected here -->
                        </ul>
                    </div>
                    <div id="typing-indicator"></div>
                    <div id="chat-replying-to-container" class="hidden p-2 bg-gray-700/50 rounded-md text-sm"></div>
                    <div class="flex gap-2 relative">
                        <textarea id="chat-message-input" placeholder="Ketik pesan..." rows="1" class="flex-grow bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 resize-none"></textarea>
                        <button id="send-chat-message-btn" class="px-5 py-2 bg-cyan-500 text-white font-bold rounded-lg hover:bg-cyan-600 transition-colors"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </main>
        </div>
        
        <div id="results-modal" class="overlay p-4">
            <div class="modal-card p-6 md:p-8 w-full max-w-2xl flex flex-col gap-4">
                <h2 class="text-3xl font-bold text-center text-lime-400">Hasil Pertandingan</h2>
                <div id="results-table-container" class="overflow-x-auto"></div>
                <button id="back-to-lobby-btn" class="mt-4 w-full px-6 py-3 bg-cyan-500 text-white font-bold rounded-md hover:bg-cyan-600 transition-colors text-lg">Kembali ke Lobby</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

        <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDVphUcSBbIG98ueli8OrhkSnC3oHV4FHc",
    authDomain: "typerid-online.firebaseapp.com",
    projectId: "typerid-online",
    storageBucket: "typerid-online.firebasestorage.app",
    messagingSenderId: "292685742496",
    appId: "1:292685742496:web:10a429c0d36222aacce4c5",
    measurementId: "G-ZZ3KDBV71T"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ==================================================
            // 3D BACKGROUND
            // ==================================================
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const particlesGeometry = new THREE.BufferGeometry;
            const particlesCnt = 5000;
            const posArray = new Float32Array(particlesCnt * 3);
            for (let i = 0; i < particlesCnt * 3; i++) { posArray[i] = (Math.random() - 0.5) * 10; }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMaterial = new THREE.PointsMaterial({ size: 0.005, color: 0x06b6d4 });
            const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            scene.add(particlesMesh);
            camera.position.z = 5;
            let mouseX = 0;
            document.addEventListener('mousemove', (event) => { mouseX = event.clientX; });
            const clock = new THREE.Clock();
            const animate = () => {
                requestAnimationFrame(animate);
                particlesMesh.rotation.y = -0.1 * clock.getElapsedTime() + (mouseX - window.innerWidth / 2) * 0.00005;
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', () => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            });

            // ==================================================
            // GLOBAL STATE & DOM ELEMENTS
            // ==================================================
            const views = {
                nameEntry: document.getElementById('name-entry-view'),
                mainApp: document.getElementById('main-app-view'),
                soloTester: document.getElementById('solo-tester'),
                practicalTester: document.getElementById('practical-tester'),
                onlineTester: document.getElementById('online-tester'),
                globalChat: document.getElementById('global-chat-view'),
                lobby: document.getElementById('lobby-view'),
                matchRoom: document.getElementById('match-room-view'),
                resultsModal: document.getElementById('results-modal'),
                usersModal: document.getElementById('users-modal'),
                sendMessageModal: document.getElementById('send-message-modal'),
            };
            const nameInput = document.getElementById('player-name-input');
            const enterAppBtn = document.getElementById('enter-app-btn');
            const mainTabNav = document.getElementById('main-tab-nav');
            const soloTabBtn = document.getElementById('solo-tab-btn');
            const practicalTabBtn = document.getElementById('practical-tab-btn');
            const onlineTabBtn = document.getElementById('online-tab-btn');
            const globalChatTabBtn = document.getElementById('global-chat-tab-btn');
            const createWpmMatchBtn = document.getElementById('create-wpm-match-btn');
            const createCpsMatchBtn = document.getElementById('create-cps-match-btn');
            const joinRandomMatchBtn = document.getElementById('join-random-match-btn');
            const joinMatchInput = document.getElementById('join-match-input');
            const joinMatchBtn = document.getElementById('join-match-btn');
            const backToLobbyBtn = document.getElementById('back-to-lobby-btn');
            const roleNoticeContainer = document.getElementById('role-notice-container');
            const adminPanelBtnContainer = document.getElementById('admin-panel-button-container');
            const countdownOverlay = document.getElementById('countdown-overlay');
            const countdownText = document.getElementById('countdown-text');
            const appLoader = document.getElementById('app-loader');

            let myPlayerId = localStorage.getItem('typerIdPlayerId') || `player_${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem('typerIdPlayerId', myPlayerId);
            let myPlayerName = '';
            let isDeveloper = false;
            let isAdmin = false;
            let currentMatchId = null;
            let unsubscribeFromMatch = null;
            let unsubscribeFromUsers = null;
            let unsubscribeFromBanned = null;
            let unsubscribeFromMessages = null;
            let unsubscribeFromBan = null;
            let unsubscribeFromGlobalChat = null;
            let unsubscribeFromTyping = null;
            let onlineState = {};
            let localCpsTimer = null;
            let localGameStarted = false;
            let presenceInterval = null;
            let activeReply = null;
            let selectedCpsDuration = 5;
            let typingTimeout = null;
            let cheatActive = false;

            const textSamples = {
                id: [
                    "Globalisasi telah membawa perubahan signifikan dalam cara kita berkomunikasi dan berinteraksi. Teknologi informasi, khususnya internet, telah meruntuhkan batas-batas geografis, memungkinkan pertukaran data dan budaya dalam skala yang belum pernah terjadi sebelumnya. Namun, tantangan seperti kesenjangan digital dan keamanan siber menjadi isu penting yang harus diatasi bersama.",
                    "Ekosistem terumbu karang merupakan salah satu keanekaragaman hayati laut yang paling kaya dan penting. Formasi ini tidak hanya menjadi rumah bagi ribuan spesies ikan dan invertebrata, tetapi juga melindungi wilayah pesisir dari erosi gelombang. Sayangnya, perubahan iklim dan polusi menjadi ancaman serius bagi kelangsungan hidup terumbu karang di seluruh dunia.",
                    "Kecerdasan buatan (AI) berkembang dengan kecepatan yang luar biasa, dari pengenalan suara hingga mobil otonom. Model pembelajaran mesin yang kompleks mampu menganalisis kumpulan data raksasa untuk menemukan pola dan membuat prediksi. Etika dalam pengembangan AI, termasuk potensi bias dan dampaknya terhadap pekerjaan, menjadi topik diskusi yang semakin mendesak di kalangan ilmuwan dan pembuat kebijakan.",
                    "Sejarah peradaban manusia adalah cerita tentang inovasi dan adaptasi. Dari penemuan api hingga revolusi agrikultur, setiap lompatan teknologi telah membentuk kembali struktur sosial dan ekonomi. Mempelajari artefak kuno dan tulisan-tulisan bersejarah memberikan kita wawasan berharga tentang bagaimana nenek moyang kita menghadapi tantangan dan membangun dunia yang kita warisi saat ini.",
                    "Pendidikan karakter di sekolah memegang peranan krusial dalam membentuk generasi muda yang berintegritas dan bertanggung jawab. Kurikulum yang seimbang antara pengetahuan akademis dan nilai-nilai moral akan menciptakan individu yang tidak hanya cerdas secara intelektual, tetapi juga matang secara emosional dan sosial.",
                    "Energi terbarukan seperti tenaga surya dan angin menjadi solusi menjanjikan untuk mengatasi krisis iklim. Investasi dalam infrastruktur hijau dan kebijakan yang mendukung transisi energi bersih adalah langkah vital untuk mencapai pembangunan berkelanjutan dan menjaga kelestarian planet kita untuk generasi mendatang.",
                    "Mitigasi bencana adalah serangkaian upaya untuk mengurangi risiko bencana, baik melalui pembangunan fisik maupun penyadaran dan peningkatan kapasitas masyarakat. Sistem peringatan dini yang efektif dan tata ruang yang berbasis risiko dapat secara signifikan mengurangi jumlah korban jiwa dan kerugian material ketika bencana terjadi.",
                    "Keberagaman budaya Indonesia adalah aset bangsa yang tak ternilai harganya. Setiap suku memiliki tradisi, bahasa, dan seni yang unik, menciptakan mozaik yang indah dan dinamis. Menjaga toleransi dan saling menghormati antarbudaya adalah kunci untuk mempertahankan persatuan dan kesatuan dalam bingkai Bhinneka Tunggal Ika.",
                    "Ekonomi digital terus menunjukkan pertumbuhan yang pesat, didorong oleh inovasi di bidang e-commerce, fintech, dan layanan on-demand. Transformasi ini membuka peluang baru bagi para pelaku usaha mikro, kecil, dan menengah untuk memperluas jangkauan pasar mereka. Namun, literasi digital dan akses internet yang merata masih menjadi pekerjaan rumah yang harus diselesaikan.",
                    "Sistem pencernaan manusia adalah jaringan organ yang kompleks dan bekerja sama untuk mengolah makanan menjadi energi. Proses ini dimulai di mulut, di mana enzim dalam air liur mulai memecah karbohidrat. Perjalanan makanan berlanjut melalui kerongkongan menuju lambung, tempat asam dan enzim lanjutan mengurai protein menjadi komponen yang lebih kecil dan sederhana.",
                    "Hutan hujan tropis sering disebut sebagai paru-paru dunia karena kemampuannya yang luar biasa dalam menyerap karbon dioksida dan menghasilkan oksigen. Selain itu, hutan ini merupakan rumah bagi lebih dari setengah spesies flora dan fauna di planet ini. Deforestasi akibat pembalakan liar dan konversi lahan menjadi ancaman utama bagi keberlangsungan ekosistem vital ini.",
                    "Arsitektur Candi Borobudur merupakan mahakarya yang memadukan unsur seni, religi, dan teknologi kuno dari peradaban Jawa. Struktur punden berundak yang megah ini dihiasi dengan ribuan panel relief yang menceritakan ajaran Buddha dan kehidupan masyarakat pada masanya. Setiap tingkat candi melambangkan tahapan perjalanan spiritual manusia untuk mencapai pencerahan sempurna atau nirwana.",
                    "Pasar modal memainkan peran penting dalam perekonomian suatu negara dengan memfasilitasi aliran dana dari investor kepada perusahaan yang membutuhkan modal. Instrumen seperti saham dan obligasi memungkinkan perusahaan untuk melakukan ekspansi bisnis, sementara investor berpotensi mendapatkan imbal hasil dari pertumbuhan perusahaan tersebut. Regulasi yang ketat diperlukan untuk menjaga stabilitas dan keadilan pasar.",
                    "Gerhana matahari total adalah fenomena astronomi langka yang terjadi ketika posisi bulan berada tepat di antara bumi dan matahari. Bayangan bulan yang jatuh ke permukaan bumi menyebabkan sebagian wilayah menjadi gelap gulita selama beberapa menit. Momen ini memberikan kesempatan unik bagi para ilmuwan untuk mempelajari korona, yaitu lapisan atmosfer terluar matahari yang biasanya tidak terlihat."
                ],
                en: [
                    "The intricate tapestry of the cosmos is woven with billions of galaxies, each containing countless stars and planetary systems. Astronomers use powerful telescopes to peer across vast distances, studying the light from distant objects to understand the origins of the universe. Discoveries like dark matter and dark energy reveal that we still have much to learn about the fundamental forces that govern reality.",
                    "Quantum mechanics describes the bizarre and counterintuitive behavior of matter and energy at theatomic and subatomic levels. Concepts such as superposition and entanglement challenge our classical understanding of the world, opening doors to new technologies like quantum computing and cryptography. These advancements promise to revolutionize fields from medicine to materials science.",
                    "The evolution of life on Earth is a story of resilience and adaptation spanning billions of years. From single-celled organisms to the complex ecosystems we see today, natural selection has sculpted an incredible diversity of forms. The fossil record provides a fragmented but fascinating glimpse into this deep history, showing how species have risen, fallen, and transformed in response to a changing planet.",
                    "Blockchain technology offers a decentralized and transparent method for recording transactions and managing data. Originally developed for cryptocurrencies like Bitcoin, its potential applications extend to supply chain management, voting systems, and digital identity verification. By removing the need for a central intermediary, it could fundamentally reshape how we trust and interact in a digital age.",
                    "Urban planning in the 21st century faces the dual challenge of accommodating growing populations while promoting sustainability and livability. Smart cities leverage data and technology to optimize transportation, reduce energy consumption, and enhance public services. Green spaces, pedestrian-friendly streets, and efficient public transit are essential components of a well-designed urban environment.",
                    "The study of psychology reveals the profound complexity of the human mind. From cognitive biases that shape our decisions to the social dynamics that influence our behavior, understanding these principles can lead to greater self-awareness and improved interpersonal relationships. Mental health is increasingly recognized as a vital component of overall well-being.",
                    "Climate change is not a distant threat but a present reality, with observable effects on weather patterns, sea levels, and ecosystems. International cooperation and individual action are both critical to curb greenhouse gas emissions and transition to a low-carbon economy. The choices we make today will determine the health of our planet for generations to come.",
                    "The principles of aerodynamics govern the flight of everything from bumblebees to jumbo jets. Understanding concepts like lift, drag, thrust, and weight is essential for aircraft design. Wind tunnels and computational fluid dynamics are crucial tools for testing and refining new aeronautical innovations.",
                    "Artificial intelligence is rapidly transforming the creative industries. Generative models can now produce original text, images, and music that are often indistinguishable from human-created works. This raises fascinating questions about the nature of creativity, authorship, and the future role of human artists in a technologically advanced world.",
                    "The global supply chain is a complex network of organizations, people, activities, information, and resources involved in moving a product or service from supplier to customer. Recent events have highlighted its fragility, prompting businesses to explore strategies like reshoring and diversification to build greater resilience against future disruptions and geopolitical shifts.",
                    "Photosynthesis is the remarkable process by which green plants, algae, and some bacteria convert light energy into chemical energy. Through a series of reactions, they use sunlight, water, and carbon dioxide to create glucose, which serves as their food, and release oxygen as a byproduct. This fundamental process sustains nearly all life on Earth by providing the primary source of organic matter and oxygen.",
                    "The Renaissance was a fervent period of European cultural, artistic, political, and economic rebirth following the Middle Ages. Generally described as taking place from the 14th century to the 17th century, the Renaissance promoted the rediscovery of classical philosophy, literature, and art. This era produced some of the greatest thinkers, authors, and artists in human history.",
                    "Cryptography is the practice and study of techniques for secure communication in the presence of third parties called adversaries. Modern cryptography is heavily based on mathematical theory and computer science practice; cryptographic algorithms are designed around computational hardness assumptions, making such algorithms hard to break in practice by any adversary.",
                    "The human brain is an astonishingly complex organ composed of billions of interconnected neurons and glial cells. It is the control center of the nervous system, responsible for thought, memory, emotion, touch, motor skills, vision, breathing, and every process that regulates our body. Neuroscientists are continuously working to unravel the mysteries of how these intricate networks give rise to consciousness and cognition."
                ]
            };

            // ==================================================
            // UTILITY FUNCTIONS
            // ==================================================
            function showToast(message, type = 'info', duration = 3000) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toast.style.animation = `toast-in 0.5s forwards, toast-out 0.5s forwards ${duration/1000 - 0.5}s`;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, duration);
            }

            function showSpecialToast(senderName, senderTag, message, type) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `special-toast ${type}-message`;
                toast.innerHTML = `<div class="font-bold mb-1 flex items-center justify-center gap-2">${senderName} ${senderTag}</div><div>${message}</div>`;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 8000);
            }

            function toggleMainTabs(show) { mainTabNav.classList.toggle('hidden', !show); }
            
            function showOverlay(overlayId, show, text = '') {
                const overlay = document.getElementById(overlayId);
                if (overlayId === 'app-loader' && text) {
                    const textElement = document.getElementById('loader-text');
                    if (textElement) textElement.textContent = text;
                }
                overlay.style.display = show ? 'flex' : 'none';
            }

            // ==================================================
            // VIEW MANAGEMENT & INITIALIZATION
            // ==================================================
            function switchView(viewName, group = null) {
                const allViews = Object.values(views);
                if (group) {
                    group.forEach(v => {
                        if (views[v]) views[v].classList.toggle('active', v === viewName);
                    });
                } else {
                    allViews.forEach(v => v.classList.remove('active'));
                    if (views[viewName]) views[viewName].classList.add('active');
                }
            }

            async function showMainApp() {
                const { db, doc, getDoc } = window.firebase;
                const name = nameInput.value.trim();
                const devPrefix = '[17102009]';
                const adminPrefix = '[082157460840]';
                if (!name) { showToast('Nama tidak boleh kosong!', 'error'); return; }

                showOverlay('app-loader', true, 'Memeriksa status...');
                const banDoc = await getDoc(doc(db, "bannedUsers", myPlayerId));
                if (banDoc.exists()) {
                    showOverlay('app-loader', false);
                    triggerBanSequence();
                    return;
                }
                showOverlay('app-loader', false);
                
                isAdmin = false; isDeveloper = false; roleNoticeContainer.innerHTML = '';
                if (name.startsWith(devPrefix)) {
                    isDeveloper = true;
                    myPlayerName = name.substring(devPrefix.length).trim() || "Developer";
                } else if (name.startsWith(adminPrefix)) {
                    isAdmin = true;
                    myPlayerName = name.substring(adminPrefix.length).trim() || "Admin";
                } else {
                    myPlayerName = name;
                }
                
                updateRoleUI();
                localStorage.setItem('typerIdPlayerName', myPlayerName);
                localStorage.setItem('typerIdIsDeveloper', isDeveloper);
                localStorage.setItem('typerIdIsAdmin', isAdmin);
                
                startPresenceSystem();
                listenForMessages();
                listenForBan();
                startGlobalChatSystem();

                switchView('mainApp', ['nameEntry', 'mainApp']);
                toggleMainTabs(true);
                const matchIdFromUrl = window.location.hash.substring(7);
                if (matchIdFromUrl) { onlineTabBtn.click(); joinMatch(matchIdFromUrl); } 
                else { soloTabBtn.click(); }
            }

            function updateRoleUI() {
                roleNoticeContainer.innerHTML = '';
                adminPanelBtnContainer.innerHTML = '';
                let roleTag = '';
                if (isDeveloper) {
                    roleTag = `<span class="dev-tag role-tag">Developer</span>`;
                    roleNoticeContainer.innerHTML = `<span class="text-sm">Kamu adalah seorang ${roleTag}</span>`;
                } else if (isAdmin) {
                    roleTag = `<span class="admin-tag role-tag">Admin</span>`;
                    roleNoticeContainer.innerHTML = `<span class="text-sm">Kamu adalah seorang ${roleTag}</span>`;
                }
                if (isDeveloper || isAdmin) {
                    adminPanelBtnContainer.innerHTML = `<button id="view-users-btn" class="px-4 py-2 bg-gray-700 text-slate-300 font-bold rounded-md hover:bg-gray-600 transition-colors text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-users-gear"></i> Lihat Pengguna</button>`;
                    document.getElementById('view-users-btn').addEventListener('click', openUsersModal);
                }
            }

            function initializeApp() {
                const savedName = localStorage.getItem('typerIdPlayerName');
                const savedDevStatus = localStorage.getItem('typerIdIsDeveloper') === 'true';
                const savedAdminStatus = localStorage.getItem('typerIdIsAdmin') === 'true';

                if (savedName) {
                    myPlayerName = savedName;
                    isDeveloper = savedDevStatus;
                    isAdmin = savedAdminStatus;
                    if (isDeveloper) { nameInput.value = `[17102009]${savedName}`; } 
                    else if (isAdmin) { nameInput.value = `[082157460840]${savedName}`; }
                    else { nameInput.value = savedName; }
                }
                switchView('nameEntry');
                injectSoloUI();
                injectPracticalUI();
                initializeGlobalChat();
            }

            enterAppBtn.addEventListener('click', showMainApp);
            nameInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') showMainApp(); });
            
            const mainTabs = [
                { btn: soloTabBtn, view: 'soloTester' },
                { btn: practicalTabBtn, view: 'practicalTester' },
                { btn: onlineTabBtn, view: 'onlineTester' },
                { btn: globalChatTabBtn, view: 'globalChat' }
            ];

            mainTabs.forEach(tab => {
                tab.btn.addEventListener('click', () => {
                    if ((tab.view === 'onlineTester' || tab.view === 'globalChat') && !myPlayerName) {
                        showToast("Masukkan nama Anda terlebih dahulu!", 'error');
                        switchView('nameEntry', ['nameEntry', 'mainApp']);
                        return;
                    }
                    mainTabs.forEach(t => t.btn.classList.remove('active'));
                    tab.btn.classList.add('active');
                    switchView(tab.view, mainTabs.map(t => t.view));
                    if(tab.view === 'onlineTester') {
                        switchView('lobby', ['lobby', 'matchRoom']);
                    }
                });
            });
            
            initializeApp();

            // ==================================================
            // SOLO MODE
            // ==================================================
            function injectSoloUI(){views.soloTester.innerHTML=`<div class="bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-700/50 flex justify-center gap-2 mb-6"><button class="solo-test-type-btn mode-btn active px-4 py-1 rounded font-semibold" data-type="wpm">WPM Test</button><button class="solo-test-type-btn mode-btn px-4 py-1 rounded font-semibold" data-type="cps">CPS Test</button></div><div id="solo-wpm-container"></div><div id="solo-cps-container" class="hidden"></div>`;injectSoloWpmUI();injectSoloCpsUI();document.querySelectorAll(".solo-test-type-btn").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll(".solo-test-type-btn").forEach(t=>t.classList.remove("active")),t.classList.add("active");const e=t.dataset.type;document.getElementById("solo-wpm-container").classList.toggle("hidden","wpm"!==e),document.getElementById("solo-cps-container").classList.toggle("hidden","cps"!==e)})})}
            function injectSoloWpmUI(){document.getElementById("solo-wpm-container").innerHTML=`<div class="flex flex-col gap-6"><div class="bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-700/50 flex justify-center gap-2"><button class="solo-mode-btn mode-btn px-4 py-1 rounded font-semibold" data-mode="time" data-duration="15">15s</button><button class="solo-mode-btn mode-btn px-4 py-1 rounded font-semibold" data-mode="time" data-duration="30">30s</button><button class="solo-mode-btn mode-btn px-4 py-1 rounded font-semibold" data-mode="time" data-duration="60">60s</button><button class="solo-mode-btn mode-btn active px-4 py-1 rounded font-semibold" data-mode="text" data-duration="0">Teks</button></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">WPM</p><p id="solo-wpm" class="text-4xl font-bold text-white">0</p></div><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Akurasi</p><p id="solo-accuracy" class="text-4xl font-bold text-white">100%</p></div><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Waktu</p><p id="solo-timer" class="text-4xl font-bold text-white">0s</p></div><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Kesalahan</p><p id="solo-error-count" class="text-4xl font-bold text-white">0</p></div></div><div id="solo-text-container" class="bg-gray-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg relative min-h-[140px] flex items-center border border-gray-700"><p id="solo-text-display" class="text-2xl leading-relaxed tracking-wide text-slate-400 select-none"></p><input id="solo-input-field" type="text" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-default" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></div><div class="flex flex-col md:flex-row gap-4"><div class="flex-grow bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-lime-500/20"><h3 class="text-center text-lime-400 font-bold mb-2 flex items-center justify-center gap-2"><i class="fa-solid fa-chart-line"></i> Statistik Sesi Ini</h3><div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center"><div><p class="text-sm">Raw WPM</p><p id="solo-raw-wpm" class="text-2xl font-bold">-</p></div><div><p class="text-sm">Karakter</p><p id="solo-char-stats" class="text-2xl font-bold">-</p></div><div><p class="text-sm">Avg. WPM</p><p id="solo-avg-wpm" class="text-2xl font-bold">-</p></div><div><p class="text-sm">Avg. Akurasi</p><p id="solo-avg-accuracy" class="text-2xl font-bold">-</p></div></div><button id="solo-reset-history-btn" class="text-xs text-red-400 hover:underline text-center w-full mt-3">Reset Statistik</button></div><div class="flex flex-col gap-2"><div class="flex gap-2"><button id="solo-lang-id" class="w-full px-4 py-2 bg-cyan-500 text-white font-bold rounded-md hover:bg-cyan-600 transition-colors">Indonesia</button><button id="solo-lang-en" class="w-full px-4 py-2 bg-gray-700 text-slate-300 font-bold rounded-md hover:bg-gray-600 transition-colors">English</button></div><button id="solo-restart-btn" class="w-full px-6 py-2 bg-lime-400 text-gray-900 font-bold rounded-md hover:bg-lime-500 transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> Mulai Ulang</button></div></div></div>`;initializeSoloWpmMode()}
            function injectSoloCpsUI(){document.getElementById("solo-cps-container").innerHTML=`<div class="flex flex-col gap-6 items-center"><div class="bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-700/50 flex justify-center gap-2 mb-2"><button class="solo-cps-duration-btn mode-btn active px-4 py-1 rounded font-semibold" data-duration="5">5s</button><button class="solo-cps-duration-btn mode-btn px-4 py-1 rounded font-semibold" data-duration="10">10s</button><button class="solo-cps-duration-btn mode-btn px-4 py-1 rounded font-semibold" data-duration="15">15s</button><button class="solo-cps-duration-btn mode-btn px-4 py-1 rounded font-semibold" data-duration="20">20s</button></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center w-full"><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">CPS</p><p id="solo-cps" class="text-4xl font-bold text-white">0</p></div><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Klik</p><p id="solo-clicks" class="text-4xl font-bold text-white">0</p></div><div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20 col-span-2"><p class="text-sm text-cyan-400">Waktu</p><p id="solo-cps-timer" class="text-4xl font-bold text-white">5s</p></div></div><div id="solo-click-area" class="w-full h-64 bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg flex items-center justify-center text-center border-2 border-dashed border-cyan-500/50 cursor-pointer hover:border-cyan-500 relative overflow-hidden"><p id="solo-click-area-text" class="text-3xl font-bold text-white">Klik di sini untuk memulai!</p></div><button id="solo-restart-cps-btn" class="w-full max-w-xs px-6 py-3 bg-lime-400 text-gray-900 font-bold rounded-md hover:bg-lime-500 transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> Mulai Ulang</button></div>`;initializeSoloCpsMode()}
            function initializeSoloWpmMode(){const t=document.getElementById("solo-text-display"),e=document.getElementById("solo-text-container"),n=document.getElementById("solo-input-field"),o=document.getElementById("solo-wpm"),a=document.getElementById("solo-accuracy"),i=document.getElementById("solo-timer"),s=document.getElementById("solo-error-count"),l=document.getElementById("solo-raw-wpm"),c=document.getElementById("solo-char-stats"),r=document.getElementById("solo-restart-btn"),d=document.getElementById("solo-lang-id"),u=document.getElementById("solo-lang-en"),m=document.getElementById("solo-avg-wpm"),p=document.getElementById("solo-avg-accuracy"),g=document.querySelectorAll(".solo-mode-btn"),h=document.getElementById("solo-reset-history-btn");let y="id",f="text",v=0,w="",b=[],k=0,C=0,E=null,M=null,S=!1,L=[];function T(){const t=localStorage.getItem("typerIdSoloHistory");L=t?JSON.parse(t):[],A()}function I(){localStorage.setItem("typerIdSoloHistory",JSON.stringify(L))}function q(){confirm("Apakah Anda yakin ingin mereset riwayat statistik solo?")&&(L=[],localStorage.removeItem("typerIdSoloHistory"),A())}function x(){y_(),w=textSamples[y][Math.floor(Math.random()*textSamples[y].length)],t.innerHTML="",b=w.split("").map(e=>{const n=document.createElement("span");return n.className="char-span",n.innerText=e,t.appendChild(n),n}),b.length>0&&b[0].classList.add("cursor","border-l-2","border-lime-400"),n.focus()}function y_(){clearInterval(M),S=!1,k=0,C=0,E=null,M=null,n.value="",o.textContent="0",a.textContent="100%",s.textContent="0",l.textContent="-",c.textContent="-",i.textContent="time"===f?`${v}s`:"0s",b&&b.length>0&&(b.forEach(t=>{t.className="char-span"}),b[0].classList.add("cursor","border-l-2","border-lime-400"))}function A(){L.length===0?(m.textContent="-",p.textContent="-"): (m.textContent=Math.round(L.reduce((t,e)=>t+e.wpm,0)/L.length),p.textContent=`${Math.round(L.reduce((t,e)=>t+e.accuracy,0)/L.length)}%`)}function B(t){if(S)return;if("Backspace"===t.key&&k>0){t.preventDefault(),k<b.length&&b[k].classList.remove("cursor","border-l-2","border-lime-400"),k--,b[k].className="char-span",b[k].classList.add("cursor","border-l-2","border-lime-400")}}function D(t){if(S||k>=w.length)return;E||(E=new Date,M=setInterval(H,500));const o=t.target.value.slice(-1);t.target.value="";const a=w[k],i=b[k];if(o!==a){i.classList.contains("char-incorrect")||(C++,i.classList.add("char-incorrect")),e.classList.remove("shake-error"),void e.offsetWidth,e.classList.add("shake-error"),H();return}i.classList.remove("char-incorrect"),i.classList.add("char-correct"),i.classList.remove("cursor","border-l-2","border-lime-400"),k++,k<w.length?b[k].classList.add("cursor","border-l-2","border-lime-400"):"text"===f&&P(),H()}function H(){if(!E||S)return;const t=(new Date-E)/1e3;if("time"===f){const e=v-t;if(i.textContent=`${Math.max(0,Math.ceil(e))}s`,e<=0)return void P()}else i.textContent=`${Math.floor(t)}s`;const e=k-C,n=k>0?Math.round(e/k*100):100,r=t>0?Math.round(e/5/(t/60)):0,d=t>0?Math.round(k/5/(t/60)):0;o.textContent=r,a.textContent=`${n}%`,s.textContent=C,l.textContent=d,c.textContent=`${e}/${C}`}function P(){if(S)return;S=!0,clearInterval(M),n.blur();const t=(new Date-E)/1e3,e=k-C,i=t>0?Math.round(e/5/(t/60)):0,s=k>0?Math.round(e/k*100):100;o.textContent=i,a.textContent=`${s}%`,k>5&&(L.push({wpm:i,accuracy:s}),I(),A())}g.forEach(t=>{t.addEventListener("click",()=>{g.forEach(t=>t.classList.remove("active")),t.classList.add("active"),f=t.dataset.mode,v=parseInt(t.dataset.duration,10),x()})}),n.addEventListener("input",D),n.addEventListener("keydown",B),r.addEventListener("click",x),d.addEventListener("click",()=>U("id")),u.addEventListener("click",()=>U("en")),t.addEventListener("click",()=>n.focus()),h.addEventListener("click",q);function U(t){y=t,d.classList.toggle("bg-cyan-500","id"===t),d.classList.toggle("bg-gray-700","id"!==t),u.classList.toggle("bg-cyan-500","en"===t),u.classList.toggle("bg-gray-700","en"!==t),x()}T(),x()}
            function initializeSoloCpsMode(){const t=document.getElementById("solo-click-area"),e=document.getElementById("solo-click-area-text"),n=document.getElementById("solo-cps"),o=document.getElementById("solo-clicks"),a=document.getElementById("solo-cps-timer"),i=document.getElementById("solo-restart-cps-btn"),s=document.querySelectorAll(".solo-cps-duration-btn");let l,c=5,r=0,d=!1;function u(){clearInterval(l),c=parseInt(document.querySelector(".solo-cps-duration-btn.active").dataset.duration,10),r=0,d=!1,n.textContent="0",o.textContent="0",a.textContent=`${c}s`,e.textContent="Klik di sini untuk memulai!",t.style.cursor="pointer"}function m(){if(d)return;d=!0,r=0,o.textContent="0",e.textContent="Klik!";const i=c;l=setInterval(()=>{c--,a.textContent=`${c}s`;const t=r/(i-c);n.textContent=isNaN(t)?"0":t.toFixed(2),c<=0&&p()},1e3)}function p(){clearInterval(l),d=!1;const i=parseInt(document.querySelector(".solo-cps-duration-btn.active").dataset.duration,10),s=(r/i).toFixed(2);n.textContent=s,e.textContent=`Selesai! CPS Anda: ${s}`,t.style.cursor="default"}t.addEventListener("click",e=>{!d&&c>0&&m(),d&&(r++,o.textContent=r,function(e){const n=document.createElement("span");n.className="ripple",t.appendChild(n);const o=t.getBoundingClientRect();n.style.left=`${e.clientX-o.left}px`,n.style.top=`${e.clientY-o.top}px`,n.onanimationend=()=>n.remove()}(e))}),i.addEventListener("click",u),s.forEach(t=>{t.addEventListener("click",()=>{s.forEach(t=>t.classList.remove("active")),t.classList.add("active"),u()})}),u()}

            // ==================================================
            // PRACTICAL MODE
            // ==================================================
            function injectPracticalUI() {
                const wordList = ["bisa", "kamu", "itu", "ini", "apa", "dan", "dari", "untuk", "dengan", "yang", "tidak", "akan", "tapi", "jika", "juga", "sudah", "belum", "harus", "karena", "seperti", "mereka", "adalah", "menjadi", "membuat", "lebih", "banyak", "sangat", "selalu", "waktu", "orang", "dunia", "hidup", "cinta", "rumah", "kota", "jalan", "air", "api", "bumi", "langit", "matahari", "bulan", "bintang", "pagi", "siang", "malam", "hari", "minggu", "tahun", "teman", "kerja", "sekolah", "belajar", "main", "makan", "minum", "tidur", "bangun", "pergi", "pulang", "datang", "lihat", "dengar", "bicara", "tanya", "jawab", "tahu", "pikir", "rasa", "ingin", "mau", "bukan", "atau", "hanya", "saja", "pasti", "mungkin"];
                views.practicalTester.innerHTML = `
                    <div class="flex flex-col gap-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">WPM</p><p id="practical-wpm" class="text-4xl font-bold text-white">0</p></div>
                            <div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Akurasi</p><p id="practical-accuracy" class="text-4xl font-bold text-white">100%</p></div>
                            <div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-cyan-500/20"><p class="text-sm text-cyan-400">Waktu</p><p id="practical-timer" class="text-4xl font-bold text-white">0s</p></div>
                            <div class="bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-lime-500/20"><p class="text-sm text-lime-400">STREAK</p><p id="practical-streak" class="text-4xl font-bold text-white">0</p></div>
                        </div>
                        <div id="practical-text-container" class="bg-gray-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg relative min-h-[140px] flex items-center justify-center border border-gray-700">
                            <p id="practical-text-display" class="text-6xl font-bold tracking-widest text-slate-400 select-none"></p>
                            <input id="practical-input-field" type="text" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-default" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-grow bg-gray-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg border border-lime-500/20">
                                <h3 class="text-center text-lime-400 font-bold mb-2 flex items-center justify-center gap-2"><i class="fa-solid fa-chart-line"></i> Statistik Sesi Ini</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                    <div><p class="text-sm">Raw WPM</p><p id="practical-raw-wpm" class="text-2xl font-bold">-</p></div>
                                    <div><p class="text-sm">Karakter</p><p id="practical-char-stats" class="text-2xl font-bold">-</p></div>
                                    <div><p class="text-sm">Avg. WPM</p><p id="practical-avg-wpm" class="text-2xl font-bold">-</p></div>
                                    <div><p class="text-sm">Avg. Akurasi</p><p id="practical-avg-accuracy" class="text-2xl font-bold">-</p></div>
                                </div>
                            </div>
                            <button id="practical-restart-btn" class="px-6 py-2 bg-lime-400 text-gray-900 font-bold rounded-md hover:bg-lime-500 transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-rotate-right"></i> Mulai Ulang</button>
                        </div>
                    </div>
                `;
                initializePracticalMode(wordList);
            }

            function initializePracticalMode(wordList) {
                const textDisplay = document.getElementById('practical-text-display');
                const textContainer = document.getElementById('practical-text-container');
                const inputField = document.getElementById('practical-input-field');
                const wpmEl = document.getElementById('practical-wpm');
                const accuracyEl = document.getElementById('practical-accuracy');
                const timerEl = document.getElementById('practical-timer');
                const streakEl = document.getElementById('practical-streak');
                const rawWpmEl = document.getElementById('practical-raw-wpm');
                const charStatsEl = document.getElementById('practical-char-stats');
                const avgWpmEl = document.getElementById('practical-avg-wpm');
                const avgAccuracyEl = document.getElementById('practical-avg-accuracy');
                const restartBtn = document.getElementById('practical-restart-btn');

                let currentWord = '';
                let charSpans = [];
                let currentIndex = 0;
                let totalErrorCount = 0;
                let totalCharsTyped = 0;
                let totalCorrectChars = 0;
                let startTime = null;
                let timerInterval = null;
                let streak = 0;
                let testHistory = [];
                let wordError = false;

                function loadNewWord() {
                    inputField.value = '';
                    currentIndex = 0;
                    wordError = false;
                    currentWord = wordList[Math.floor(Math.random() * wordList.length)];
                    textDisplay.innerHTML = '';
                    charSpans = currentWord.split('').map(char => {
                        const span = document.createElement('span');
                        span.className = 'char-span';
                        span.innerText = char;
                        textDisplay.appendChild(span);
                        return span;
                    });
                    if (charSpans.length > 0) {
                        charSpans[0].classList.add('cursor', 'border-l-2', 'border-lime-400');
                    }
                    inputField.focus();
                }

                function resetState() {
                    clearInterval(timerInterval);
                    startTime = null;
                    timerInterval = null;
                    streak = 0;
                    totalErrorCount = 0;
                    totalCharsTyped = 0;
                    totalCorrectChars = 0;
                    testHistory = [];
                    wpmEl.textContent = '0';
                    accuracyEl.textContent = '100%';
                    timerEl.textContent = '0s';
                    streakEl.textContent = '0';
                    rawWpmEl.textContent = '-';
                    charStatsEl.textContent = '-';
                    avgWpmEl.textContent = '-';
                    avgAccuracyEl.textContent = '-';
                    loadNewWord();
                }

                function updateStats() {
                    if (!startTime) return;
                    const elapsedTime = (new Date() - startTime) / 1000;
                    timerEl.textContent = `${Math.floor(elapsedTime)}s`;
                    
                    const wpm = elapsedTime > 0 ? Math.round((totalCorrectChars / 5) / (elapsedTime / 60)) : 0;
                    const rawWpm = elapsedTime > 0 ? Math.round((totalCharsTyped / 5) / (elapsedTime / 60)) : 0;
                    const accuracy = totalCharsTyped > 0 ? Math.round((totalCorrectChars / totalCharsTyped) * 100) : 100;

                    wpmEl.textContent = wpm;
                    rawWpmEl.textContent = rawWpm;
                    accuracyEl.textContent = `${accuracy}%`;
                    streakEl.textContent = streak;
                    charStatsEl.textContent = `${totalCorrectChars}/${totalErrorCount}`;
                }
                
                function updateAverageStats() {
                    if (testHistory.length === 0) return;
                    const totalWpm = testHistory.reduce((sum, test) => sum + test.wpm, 0);
                    const totalAccuracy = testHistory.reduce((sum, test) => sum + test.accuracy, 0);
                    avgWpmEl.textContent = Math.round(totalWpm / testHistory.length);
                    avgAccuracyEl.textContent = `${Math.round(totalAccuracy / testHistory.length)}%`;
                }

                function handleTextInput(e) {
                    if (!startTime) {
                        startTime = new Date();
                        timerInterval = setInterval(updateStats, 500);
                    }

                    const typedChar = e.target.value.slice(-1);
                    e.target.value = '';

                    if (currentIndex >= currentWord.length) return;

                    const expectedChar = currentWord[currentIndex];
                    const currentSpan = charSpans[currentIndex];
                    
                    if (!currentSpan.classList.contains('char-correct') && !currentSpan.classList.contains('char-incorrect')) {
                        totalCharsTyped++;
                    }

                    if (typedChar === expectedChar) {
                        currentSpan.className = 'char-span char-correct';
                        if (!wordError) {
                           totalCorrectChars++;
                        }
                        
                        currentSpan.classList.remove('cursor', 'border-l-2', 'border-lime-400');
                        currentIndex++;
                        
                        if (currentIndex < currentWord.length) {
                            charSpans[currentIndex].classList.add('cursor', 'border-l-2', 'border-lime-400');
                        } else { // Word finished
                            if (!wordError) {
                                streak++;
                            }
                            const elapsedTime = (new Date() - startTime) / 1000;
                            const currentWpm = elapsedTime > 0 ? Math.round((totalCorrectChars / 5) / (elapsedTime / 60)) : 0;
                            const currentAccuracy = totalCharsTyped > 0 ? Math.round((totalCorrectChars / totalCharsTyped) * 100) : 100;
                            testHistory.push({ wpm: currentWpm, accuracy: currentAccuracy });
                            updateAverageStats();
                            
                            setTimeout(loadNewWord, 100);
                        }
                    } else {
                        if (!currentSpan.classList.contains('char-incorrect')) {
                            currentSpan.className = 'char-span char-incorrect';
                            if (!wordError) {
                                totalErrorCount++;
                                wordError = true;
                                streak = 0; // Reset streak on error
                            }
                            textContainer.classList.remove('shake-error');
                            void textContainer.offsetWidth; // Trigger reflow
                            textContainer.classList.add('shake-error');
                        }
                    }
                    updateStats();
                }
                
                inputField.addEventListener('input', handleTextInput);
                restartBtn.addEventListener('click', resetState);
                textDisplay.addEventListener('click', () => inputField.focus());
                resetState();
            }

            // ==================================================
            // ONLINE, ADMIN & GLOBAL CHAT SYSTEMS
            // ==================================================
            function startPresenceSystem() {
                const { db, doc, setDoc, serverTimestamp } = window.firebase;
                const userDocRef = doc(db, "users", myPlayerId);
                const updatePresence = () => {
                    if (myPlayerName) {
                        setDoc(userDocRef, {
                            name: myPlayerName,
                            isDeveloper,
                            isAdmin,
                            lastSeen: serverTimestamp()
                        }, { merge: true });
                    }
                };
                updatePresence();
                if (presenceInterval) clearInterval(presenceInterval);
                presenceInterval = setInterval(updatePresence, 30000);
            }

            function listenForMessages() {
                const { db, collection, onSnapshot, doc, deleteDoc } = window.firebase;
                const messagesRef = collection(db, "users", myPlayerId, "messages");
                if (unsubscribeFromMessages) unsubscribeFromMessages();
                unsubscribeFromMessages = onSnapshot(messagesRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const messageData = change.doc.data();
                            let senderTag = '';
                            let messageType = 'info';
                            if (messageData.senderIsDeveloper) {
                                senderTag = `<span class="dev-tag role-tag">Developer</span>`;
                                messageType = 'dev';
                            } else if (messageData.senderIsAdmin) {
                                senderTag = `<span class="admin-tag role-tag">Admin</span>`;
                                messageType = 'admin';
                            }
                            showSpecialToast(messageData.senderName, senderTag, messageData.message, messageType);
                            deleteDoc(doc(db, "users", myPlayerId, "messages", change.doc.id));
                        }
                    });
                });
            }

            function listenForBan() {
                const { db, doc, onSnapshot } = window.firebase;
                if(unsubscribeFromBan) unsubscribeFromBan();
                unsubscribeFromBan = onSnapshot(doc(db, "bannedUsers", myPlayerId), (doc) => {
                    if (doc.exists()) {
                        triggerBanSequence();
                    }
                });
            }

            function triggerBanSequence() {
                showOverlay('banned-overlay', true);
                let countdown = 5;
                const timer = setInterval(() => {
                    countdown--;
                    document.getElementById('ban-timer').textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        document.body.innerHTML = '';
                        window.location.reload();
                    }
                }, 1000);
            }

            // --- Admin Panel ---
            function openUsersModal() {
                if (!isAdmin && !isDeveloper) {
                    document.getElementById('users-list-container').style.display = 'none';
                    document.getElementById('banned-list-container').style.display = 'none';
                    document.getElementById('users-modal-permission-denied').style.display = 'block';
                } else {
                    document.getElementById('users-modal-permission-denied').style.display = 'none';
                    document.getElementById('online-users-tab').click();
                }
                showOverlay('users-modal', true);
            }

            function subscribeToUsersList() {
                const { db, collection, query, where, onSnapshot } = window.firebase;
                const userListContainer = document.getElementById('users-list-container');
                const onlineUserCount = document.getElementById('online-user-count');
                const oneMinuteAgo = new Date(Date.now() - 60000);

                const q = query(collection(db, "users"), where("lastSeen", ">", oneMinuteAgo));
                if (unsubscribeFromUsers) unsubscribeFromUsers();
                unsubscribeFromUsers = onSnapshot(q, (snapshot) => {
                    let usersHTML = '';
                    let count = 0;
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userId = doc.id;
                        if (userId === myPlayerId) return;
                        count++;
                        
                        let roleTag = '<span class="user-tag role-tag">User</span>';
                        if (user.isDeveloper) roleTag = '<span class="dev-tag role-tag">Developer</span>';
                        else if (user.isAdmin) roleTag = '<span class="admin-tag role-tag">Admin</span>';
                        
                        let actionsHTML = '';
                        if(isDeveloper && !user.isDeveloper) {
                             actionsHTML += `<button data-userid="${userId}" data-username="${user.name}" class="ban-btn ml-auto bg-red-600 px-3 py-1 rounded-md text-xs">Banned</button>`;
                        }
                        if(isDeveloper || isAdmin) {
                            actionsHTML += `<button data-userid="${userId}" data-username="${user.name}" class="message-btn ml-2 bg-cyan-600 px-3 py-1 rounded-md text-xs">Pesan</button>`;
                        }

                        usersHTML += `<div class="flex items-center p-2 border-b border-gray-600">
                            <span>${user.name}</span>
                            <span class="ml-2">${roleTag}</span>
                            <div class="ml-auto flex gap-2">${actionsHTML}</div>
                        </div>`;
                    });
                    onlineUserCount.textContent = count;
                    userListContainer.innerHTML = usersHTML || '<p class="text-slate-400 text-center">Tidak ada pengguna online lain.</p>';
                });
            }
            
            function subscribeToBannedList() {
                const { db, collection, onSnapshot } = window.firebase;
                const bannedListContainer = document.getElementById('banned-list-container');
                const bannedUserCount = document.getElementById('banned-user-count');
                
                if (unsubscribeFromBanned) unsubscribeFromBanned();
                unsubscribeFromBanned = onSnapshot(collection(db, "bannedUsers"), (snapshot) => {
                    let bannedHTML = '';
                    bannedUserCount.textContent = snapshot.size;
                    snapshot.forEach(doc => {
                        const bannedUser = doc.data();
                        const userId = doc.id;
                        
                        let actionsHTML = '';
                        if(isDeveloper) {
                             actionsHTML += `<button data-userid="${userId}" data-username="${bannedUser.username}" class="unban-btn ml-auto bg-green-600 px-3 py-1 rounded-md text-xs">Lepas Ban</button>`;
                        }

                        bannedHTML += `<div class="flex items-center p-2 border-b border-gray-600">
                            <span>${bannedUser.username || `ID: ${userId.substring(0,10)}...`}</span>
                            <span class="ml-2 text-xs text-gray-400">(oleh ${bannedUser.bannedBy})</span>
                            <div class="ml-auto flex gap-2">${actionsHTML}</div>
                        </div>`;
                    });
                    bannedListContainer.innerHTML = bannedHTML || '<p class="text-slate-400 text-center">Tidak ada pengguna yang dibanned.</p>';
                });
            }

            document.getElementById('close-users-modal-btn').addEventListener('click', () => {
                if (unsubscribeFromUsers) { unsubscribeFromUsers(); unsubscribeFromUsers = null; }
                if (unsubscribeFromBanned) { unsubscribeFromBanned(); unsubscribeFromBanned = null; }
                showOverlay('users-modal', false);
            });
            
            document.getElementById('online-users-tab').addEventListener('click', (e) => {
                document.getElementById('banned-users-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('users-list-container').classList.remove('hidden');
                document.getElementById('banned-list-container').classList.add('hidden');
                if (unsubscribeFromBanned) { unsubscribeFromBanned(); unsubscribeFromBanned = null; }
                subscribeToUsersList();
            });

            document.getElementById('banned-users-tab').addEventListener('click', (e) => {
                document.getElementById('online-users-tab').classList.remove('active');
                e.target.classList.add('active');
                document.getElementById('users-list-container').classList.add('hidden');
                document.getElementById('banned-list-container').classList.remove('hidden');
                if (unsubscribeFromUsers) { unsubscribeFromUsers(); unsubscribeFromUsers = null; }
                subscribeToBannedList();
            });

            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('ban-btn')) {
                    const userId = e.target.dataset.userid;
                    const username = e.target.dataset.username;
                    if (confirm(`Apakah Anda yakin ingin membanned ${username}?`)) {
                        banUser(userId, username);
                    }
                }
                 if (e.target.classList.contains('unban-btn')) {
                    const userId = e.target.dataset.userid;
                    const username = e.target.dataset.username;
                    if (confirm(`Apakah Anda yakin ingin melepas ban untuk ${username}?`)) {
                        unbanUser(userId);
                    }
                }
                if (e.target.classList.contains('message-btn')) {
                    const userId = e.target.dataset.userid;
                    const username = e.target.dataset.username;
                    openSendMessageModal(userId, username);
                }
                if (e.target.closest('.kick-btn')) {
                    const button = e.target.closest('.kick-btn');
                    const userId = button.dataset.kickId;
                    const username = button.dataset.kickName;
                    if (confirm(`Apakah Anda yakin ingin mengeluarkan ${username} dari room?`)) {
                        kickPlayer(userId);
                    }
                }
            });

            async function banUser(userId, username) {
                const { db, doc, setDoc } = window.firebase;
                await setDoc(doc(db, "bannedUsers", userId), { 
                    bannedBy: myPlayerName, 
                    username: username,
                    timestamp: new Date() 
                });
                showToast(`Pengguna ${username} telah dibanned.`, 'info');
            }
            
            async function unbanUser(userId) {
                const { db, doc, deleteDoc } = window.firebase;
                await deleteDoc(doc(db, "bannedUsers", userId));
                showToast(`Ban untuk pengguna telah dilepas.`, 'info');
            }

            function openSendMessageModal(userId, username) {
                document.getElementById('message-recipient-name').textContent = username;
                document.getElementById('confirm-send-message-btn').dataset.userid = userId;
                document.getElementById('message-input').value = '';
                showOverlay('send-message-modal', true);
            }

            document.getElementById('cancel-send-message-btn').addEventListener('click', () => showOverlay('send-message-modal', false));
            document.getElementById('confirm-send-message-btn').addEventListener('click', async (e) => {
                const { db, collection, addDoc, serverTimestamp } = window.firebase;
                const targetId = e.target.dataset.userid;
                const message = document.getElementById('message-input').value.trim();
                if (!message) { showToast('Pesan tidak boleh kosong!', 'error'); return; }

                await addDoc(collection(db, "users", targetId, "messages"), {
                    message,
                    senderName: myPlayerName,
                    senderIsDeveloper: isDeveloper,
                    senderIsAdmin: isAdmin,
                    timestamp: serverTimestamp()
                });
                showToast('Pesan terkirim!', 'info');
                document.getElementById('message-input').value = '';
                showOverlay('send-message-modal', false);
            });

            // --- Global Chat Helper Functions ---
            async function deleteChatMessage(messageId) {
                const { db, doc, updateDoc } = window.firebase;
                const messageRef = doc(db, "globalChat", messageId);
                await updateDoc(messageRef, {
                    text: '',
                    deleted: true
                });
            }

            async function reactToMessage(messageId, emoji) {
                const { db, doc, getDoc, updateDoc } = window.firebase;
                const messageRef = doc(db, "globalChat", messageId);
                const docSnap = await getDoc(messageRef);
                if (!docSnap.exists()) return;

                const messageData = docSnap.data();
                const reactions = messageData.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }

                const userIndex = reactions[emoji].indexOf(myPlayerId);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                } else {
                    reactions[emoji].push(myPlayerId);
                }

                if (reactions[emoji].length === 0) {
                    delete reactions[emoji];
                }

                await updateDoc(messageRef, { reactions });
            }

            function enterEditMode(messageContainer, messageId, currentText) {
                const bubble = messageContainer.querySelector('.chat-bubble');
                const originalContent = bubble.innerHTML;
                
                bubble.innerHTML = `
                    <textarea class="edit-textarea w-full bg-gray-900 text-white p-2 rounded-md resize-none">${currentText}</textarea>
                    <div class="flex justify-end gap-2 mt-2">
                        <button class="cancel-edit-btn text-xs bg-gray-600 px-2 py-1 rounded">Batal</button>
                        <button class="save-edit-btn text-xs bg-cyan-500 px-2 py-1 rounded">Simpan</button>
                    </div>
                `;

                const textarea = bubble.querySelector('.edit-textarea');
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = textarea.value.length;

                bubble.querySelector('.cancel-edit-btn').onclick = () => {
                    bubble.innerHTML = originalContent;
                };

                bubble.querySelector('.save-edit-btn').onclick = async () => {
                    const newText = textarea.value.trim();
                    if (newText && newText !== currentText) {
                        const { db, doc, updateDoc, serverTimestamp } = window.firebase;
                        const messageRef = doc(db, "globalChat", messageId);
                        await updateDoc(messageRef, {
                            text: newText,
                            isEdited: true,
                            timestamp: serverTimestamp()
                        });
                    } else {
                         bubble.innerHTML = originalContent;
                    }
                };
            }
            
            function toggleReactionPicker(messageContainer) {
                // Close any other open pickers
                document.querySelectorAll('.reaction-picker').forEach(picker => {
                    if (picker.parentElement !== messageContainer) {
                        picker.remove();
                    }
                });

                let picker = messageContainer.querySelector('.reaction-picker');
                if (picker) {
                    picker.remove();
                    return;
                }

                picker = document.createElement('div');
                picker.className = 'reaction-picker';
                
                const emojis = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
                emojis.forEach(emoji => {
                    const btn = document.createElement('button');
                    btn.className = 'p-1 rounded-md hover:bg-gray-600 text-xl';
                    btn.textContent = emoji;
                    btn.onclick = () => {
                        reactToMessage(messageContainer.dataset.messageId, emoji);
                        picker.remove();
                    };
                    picker.appendChild(btn);
                });

                messageContainer.appendChild(picker);
            }

            // --- Global Chat Main Functions ---
            function initializeGlobalChat() {
                const messageInput = document.getElementById('chat-message-input');
                const sendBtn = document.getElementById('send-chat-message-btn');
                
                sendBtn.addEventListener('click', sendChatMessage);
                messageInput.addEventListener('keyup', (e) => {
                    updateTypingStatus();
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });

                document.getElementById('chat-messages-list').addEventListener('click', (e) => {
                    const messageContainer = e.target.closest('.chat-message-container');
                    if (!messageContainer) return;

                    const messageId = messageContainer.dataset.messageId;
                    const senderId = messageContainer.dataset.senderId;
                    const senderName = messageContainer.dataset.senderName;
                    const currentText = messageContainer.querySelector('.message-text')?.textContent;

                    // Handle options menu clicks
                    if (e.target.closest('.option-btn')) {
                        const button = e.target.closest('.option-btn');
                        if (button.classList.contains('reply-option-btn')) {
                            activateReply(messageId, senderName);
                        } else if (button.classList.contains('edit-option-btn')) {
                            enterEditMode(messageContainer, messageId, currentText);
                        } else if (button.classList.contains('delete-option-btn')) {
                            if (confirm('Apakah Anda yakin ingin menghapus pesan ini?')) {
                                deleteChatMessage(messageId);
                            }
                        } else if (button.classList.contains('react-option-btn')) {
                            toggleReactionPicker(messageContainer);
                        }
                    }

                    // Handle reaction clicks
                    if (e.target.closest('.reaction-pill')) {
                        const pill = e.target.closest('.reaction-pill');
                        const emoji = pill.dataset.emoji;
                        reactToMessage(messageId, emoji);
                    }
                });
            }

            function startGlobalChatSystem() {
                if (unsubscribeFromGlobalChat) unsubscribeFromGlobalChat();
                if (unsubscribeFromTyping) unsubscribeFromTyping();

                listenToGlobalChat();
                listenForTyping();
            }
            
            function activateReply(messageId, senderName) {
                activeReply = { id: messageId, name: senderName };
                const container = document.getElementById('chat-replying-to-container');
                container.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>Membalas <strong>${senderName}</strong></span>
                        <button id="cancel-reply-btn" class="text-red-400 text-xl">&times;</button>
                    </div>
                `;
                container.classList.remove('hidden');
                document.getElementById('cancel-reply-btn').addEventListener('click', cancelReply);
            }

            function cancelReply() {
                activeReply = null;
                document.getElementById('chat-replying-to-container').classList.add('hidden');
            }

            async function sendChatMessage() {
                const { db, collection, addDoc, serverTimestamp, doc, deleteDoc } = window.firebase;
                const messageInput = document.getElementById('chat-message-input');
                const text = messageInput.value.trim();
                if (!text) return;

                const messageData = {
                    text,
                    senderId: myPlayerId,
                    senderName: myPlayerName,
                    senderIsAdmin: isAdmin,
                    senderIsDeveloper: isDeveloper,
                    timestamp: serverTimestamp(),
                    reactions: {},
                    isEdited: false,
                    deleted: false,
                };

                if (activeReply) {
                    messageData.replyTo = activeReply;
                }

                try {
                    // Optimistic UI update
                    const tempId = `temp_${Date.now()}`;
                    const optimisticMessageData = { ...messageData, timestamp: { toMillis: () => Date.now() } };
                    const li = renderChatMessage(optimisticMessageData, tempId);
                    const messagesList = document.getElementById('chat-messages-list');
                    messagesList.insertBefore(li, messagesList.firstChild);
                    messagesList.parentElement.scrollTop = messagesList.parentElement.scrollHeight;


                    messageInput.value = '';
                    cancelReply();
                    if (typingTimeout) clearTimeout(typingTimeout);
                    if (myPlayerId) {
                        deleteDoc(doc(db, "typingStatus", myPlayerId));
                    }
                    
                    const docRef = await addDoc(collection(db, "globalChat"), messageData);
                    const tempLi = messagesList.querySelector(`li[data-message-id="${tempId}"]`);
                    if (tempLi) {
                        tempLi.dataset.messageId = docRef.id;
                    }

                } catch (error) {
                    console.error("Error sending chat message:", error);
                    showToast("Gagal mengirim pesan.", "error");
                    const tempLi = document.querySelector(`li[data-message-id^="temp_"]`);
                    if (tempLi) tempLi.remove();
                }
            }

            function listenToGlobalChat() {
                const { db, collection, query, orderBy, limit, onSnapshot } = window.firebase;
                const messagesList = document.getElementById('chat-messages-list');
                const chatStatus = document.getElementById('chat-status-indicator');
                const q = query(collection(db, "globalChat"), orderBy("timestamp", "desc"), limit(50));
                
                if (unsubscribeFromGlobalChat) unsubscribeFromGlobalChat();

                unsubscribeFromGlobalChat = onSnapshot(q, (snapshot) => {
                    chatStatus.innerHTML = `<span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div> Live</span>`;
                    snapshot.docChanges().forEach(change => {
                        const messageId = change.doc.id;
                        const messageData = change.doc.data();
                        
                        // Ignore local optimistic updates that are now confirmed
                        if (messageData.senderId === myPlayerId && document.querySelector(`li[data-message-id="${messageId}"]`)) {
                           return;
                        }

                        const existingLi = messagesList.querySelector(`li[data-message-id="${messageId}"]`);

                        if (change.type === "added") {
                            if(existingLi) return; // Already handled optimistically
                            const li = renderChatMessage(messageData, messageId);
                            li.classList.add('new-message');
                            
                            const existingMessages = Array.from(messagesList.querySelectorAll('li'));
                            const newerMessage = existingMessages.find(msg => {
                                const msgTimestamp = msg.dataset.timestamp ? parseInt(msg.dataset.timestamp, 10) : 0;
                                const newTimestamp = messageData.timestamp ? messageData.timestamp.toMillis() : 0;
                                return msgTimestamp > newTimestamp;
                            });
                            messagesList.insertBefore(li, newerMessage || null);
                        } else if (change.type === "modified") {
                            if (existingLi) {
                                const newLi = renderChatMessage(messageData, messageId);
                                existingLi.replaceWith(newLi);
                            }
                        } else if (change.type === "removed") {
                            if (existingLi) existingLi.remove();
                        }
                    });
                }, (error) => {
                    console.error("Chat listener error:", error);
                    chatStatus.innerHTML = `<span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div> Error</span>`;
                });
            }

            function renderChatMessage(message, messageId) {
                const isMe = message.senderId === myPlayerId;
                const li = document.createElement('li');
                li.className = `chat-message-container relative flex flex-col ${isMe ? 'items-end my-message' : 'items-start other-message'}`;
                li.dataset.messageId = messageId;
                li.dataset.senderId = message.senderId;
                li.dataset.senderName = message.senderName;
                if (message.timestamp) {
                    li.dataset.timestamp = message.timestamp.toMillis();
                }

                let bubbleClass = 'user-bubble';
                if (message.senderIsDeveloper) bubbleClass = isMe ? 'my-dev-bubble dev-bubble-base' : 'dev-bubble dev-bubble-base';
                else if (message.senderIsAdmin) bubbleClass = isMe ? 'my-admin-bubble' : 'admin-bubble';
                else if (isMe) bubbleClass = 'my-bubble';
                
                let roleTagHTML = '';
                if (message.senderIsDeveloper) roleTagHTML = `<span class="dev-tag role-tag ml-2">Developer</span>`;
                else if (message.senderIsAdmin) roleTagHTML = `<span class="admin-tag role-tag ml-2">Admin</span>`;

                let replyHTML = '';
                if(message.replyTo) {
                    replyHTML = `<div class="reply-content">
                        <strong>${message.replyTo.name}</strong>
                    </div>`;
                }

                const optionsHTML = `
                    <div class="message-options">
                        <button class="option-btn react-option-btn" title="Reaksi"><i class="fa-regular fa-face-smile"></i></button>
                        <button class="option-btn reply-option-btn" title="Balas"><i class="fa-solid fa-reply"></i></button>
                        ${isMe ? `<button class="option-btn edit-option-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button>` : ''}
                        ${isMe || isDeveloper ? `<button class="option-btn delete-option-btn" title="Hapus"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                `;

                const reactionsHTML = `
                    <div class="reactions-container">
                        ${Object.entries(message.reactions || {}).map(([emoji, userIds]) => {
                            if (userIds.length === 0) return '';
                            const userHasReacted = userIds.includes(myPlayerId);
                            return `<div class="reaction-pill ${userHasReacted ? 'reacted' : ''}" data-emoji="${emoji}">
                                        <span>${emoji}</span>
                                        <span class="ml-1 text-xs">${userIds.length}</span>
                                    </div>`;
                        }).join('')}
                    </div>
                `;

                const editedIndicator = message.isEdited ? `<span class="text-xs text-slate-400 ml-2">(diedit)</span>` : '';
                const messageContent = message.deleted ? `<p class="text-slate-400 italic">Pesan ini telah dihapus.</p>` : `<p class="message-text">${message.text.replace(/\n/g, '<br>')}</p>`;

                li.innerHTML = `
                    ${optionsHTML}
                    <div class="chat-bubble ${bubbleClass}">
                        <div class="flex justify-between items-center gap-4 mb-1">
                           <strong class="text-sm flex items-center">${isMe ? 'Anda' : message.senderName} ${roleTagHTML}</strong>
                        </div>
                        ${replyHTML}
                        ${messageContent}
                    </div>
                    ${reactionsHTML}
                `;
                return li;
            }
            
            async function updateTypingStatus() {
                if (!myPlayerId || !myPlayerName) return;
                const { db, doc, setDoc, deleteDoc, serverTimestamp } = window.firebase;
                const typingRef = doc(db, "typingStatus", myPlayerId);

                if (typingTimeout) clearTimeout(typingTimeout);

                const messageInput = document.getElementById('chat-message-input');
                if (messageInput.value.trim().length > 0) {
                    await setDoc(typingRef, {
                        name: myPlayerName,
                        timestamp: serverTimestamp()
                    });

                    typingTimeout = setTimeout(async () => {
                        await deleteDoc(typingRef);
                    }, 3000);
                } else {
                    await deleteDoc(typingRef);
                }
            }

            function listenForTyping() {
                const { db, collection, query, where, onSnapshot } = window.firebase;
                const typingIndicator = document.getElementById('typing-indicator');
                const threeSecondsAgo = () => new Date(Date.now() - 3000);

                const q = query(collection(db, "typingStatus"), where("timestamp", ">", threeSecondsAgo()));

                if (unsubscribeFromTyping) unsubscribeFromTyping();

                unsubscribeFromTyping = onSnapshot(q, (snapshot) => {
                    const typers = [];
                    snapshot.forEach(doc => {
                        if (doc.id !== myPlayerId) {
                            typers.push(doc.data().name);
                        }
                    });

                    if (typers.length === 0) {
                        typingIndicator.textContent = '';
                    } else if (typers.length === 1) {
                        typingIndicator.textContent = `${typers[0]} sedang mengetik...`;
                    } else if (typers.length === 2) {
                        typingIndicator.textContent = `${typers[0]} dan ${typers[1]} sedang mengetik...`;
                    } else {
                        typingIndicator.textContent = `${typers[0]} dan ${typers.length - 1} lainnya sedang mengetik...`;
                    }
                });
            }

            // --- Match Logic ---
            async function createMatch(matchType) {
                showOverlay('app-loader', true, 'Membuat room...');
                const { db, collection, addDoc, serverTimestamp } = window.firebase;
                
                try {
                    const matchRef = await addDoc(collection(db, "matches"), {
                        matchType, 
                        textToType: '',
                        language: 'en',
                        cpsDuration: selectedCpsDuration, 
                        status: "waiting", 
                        createdAt: serverTimestamp(), 
                        hostId: myPlayerId,
                        players: { [myPlayerId]: { name: myPlayerName, score: 0, progress: 0, finished: false, isDeveloper, isAdmin, accuracy: 0, duration: 0 } }
                    });
                    enterMatchRoom(matchRef.id);
                } catch (error) {
                    console.error("Gagal membuat match:", error);
                    showToast("Gagal membuat pertandingan. Coba lagi.", "error");
                } finally {
                    showOverlay('app-loader', false);
                }
            }

            async function joinMatch(matchId) {
                showOverlay('app-loader', true, 'Bergabung dengan room...');
                const { db, doc, runTransaction } = window.firebase;
                if (!matchId) { showToast("Masukkan kode pertandingan.", "error"); showOverlay('app-loader', false); return; }
                const matchDocRef = doc(db, "matches", matchId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(matchDocRef);
                        if (!docSnap.exists()) { throw "Pertandingan tidak ditemukan!"; }
                        const matchData = docSnap.data();
                        if (matchData.status !== 'waiting') { throw "Pertandingan sudah dimulai atau selesai!"; }
                        transaction.update(matchDocRef, {
                            [`players.${myPlayerId}`]: { name: myPlayerName, score: 0, progress: 0, finished: false, isDeveloper, isAdmin, accuracy: 0, duration: 0 }
                        });
                    });
                    enterMatchRoom(matchId);
                } catch (error) {
                    console.error("Gagal bergabung:", error);
                    showToast(`Gagal bergabung: ${error}`, "error");
                    try { history.pushState("", document.title, window.location.pathname + window.location.search); } catch(e) {}
                } finally {
                    showOverlay('app-loader', false);
                }
            }
            
            async function joinRandomMatch() {
                showOverlay('app-loader', true, 'Mencari pertandingan...');
                const { db, collection, query, where, getDocs, limit } = window.firebase;
                try {
                    const q = query(
                        collection(db, "matches"), 
                        where("status", "==", "waiting"),
                        limit(10)
                    );
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        showToast("Tidak ada pertandingan yang tersedia. Coba buat satu!", "info");
                    } else {
                        const randomDoc = querySnapshot.docs[Math.floor(Math.random() * querySnapshot.docs.length)];
                        await joinMatch(randomDoc.id);
                    }
                } catch (error) {
                    console.error("Error mencari match acak:", error);
                    showToast("Gagal mencari pertandingan acak.", "error");
                } finally {
                    showOverlay('app-loader', false);
                }
            }

            function enterMatchRoom(matchId) {
                currentMatchId = matchId;
                localGameStarted = false;
                toggleMainTabs(false);
                try { window.location.hash = `match=${matchId}`; } catch(e) {}
                switchView('onlineTester', ['soloTester', 'practicalTester', 'onlineTester', 'globalChat']);
                switchView('matchRoom', ['lobby', 'matchRoom']);
                renderMatchRoomSkeleton();
                if (isDeveloper) {
                    setupDevCheatButton();
                }
                listenToMatch(matchId);
            }

            function listenToMatch(matchId) {
                const { db, doc, onSnapshot } = window.firebase;
                const matchDocRef = doc(db, "matches", matchId);
                if (unsubscribeFromMatch) unsubscribeFromMatch();
                unsubscribeFromMatch = onSnapshot(matchDocRef, (doc) => {
                    if (!doc.exists()) {
                        if(views.resultsModal.style.display === 'flex') return;
                        showToast("Pertandingan telah dibubarkan.", "error");
                        leaveMatch(true);
                        return;
                    }
                    const matchData = doc.data();
                    
                    if (onlineState.players && !matchData.players[myPlayerId] && !localGameStarted) {
                        const hostName = onlineState.players[onlineState.hostId]?.name || 'Host';
                        showToast(`Anda telah dikeluarkan dari room oleh ${hostName}`, 'error');
                        leaveMatch(true);
                        return;
                    }

                    onlineState = matchData;
                    if (views.resultsModal.style.display === 'flex') return;
                    updateMatchRoomUI(matchData);
                    if (matchData.status === 'starting' && !localGameStarted) {
                        showCountdown();
                    } else if (matchData.status === 'playing' && !localGameStarted) {
                        localGameStarted = true;
                        if (matchData.matchType === 'wpm') initializeOnlineWpmGame(matchData);
                        else initializeOnlineCpsGame(matchData);
                    }
                    const allPlayersFinished = Object.keys(matchData.players).length > 0 && Object.values(matchData.players).every(p => p.finished);
                    if (allPlayersFinished && matchData.status === 'playing') {
                        showResults(matchData);
                    }
                });
            }

            async function leaveMatch(isMatchDeleted = false) {
                if (unsubscribeFromMatch) { unsubscribeFromMatch(); unsubscribeFromMatch = null; }
                if (currentMatchId && !isMatchDeleted) {
                    const { db, doc, runTransaction } = window.firebase;
                    const matchDocRef = doc(db, "matches", currentMatchId);
                    try {
                        await runTransaction(db, async (transaction) => {
                            const matchDoc = await transaction.get(matchDocRef);
                            if (!matchDoc.exists()) return;
                            const data = matchDoc.data();
                            const newPlayers = { ...data.players };
                            delete newPlayers[myPlayerId];
                            if (data.hostId === myPlayerId || Object.keys(newPlayers).length === 0) {
                                transaction.delete(matchDocRef);
                            } else {
                                transaction.update(matchDocRef, { players: newPlayers });
                            }
                        });
                    } catch (error) { console.error("Gagal keluar dari match:", error); }
                }
                resetOnlineState();
            }

            function resetOnlineState() {
                const cheatBtn = document.getElementById('dev-cheat-btn');
                if (cheatBtn) cheatBtn.remove();
                cheatActive = false;

                currentMatchId = null;
                onlineState = {};
                localGameStarted = false;
                toggleMainTabs(true);
                try {
                    if (window.location.hash) {
                        history.pushState("", document.title, window.location.pathname + window.location.search);
                    }
                } catch (e) {
                    console.warn("Could not clear URL hash due to security restrictions.");
                }
                switchView('mainApp');
                onlineTabBtn.click();
            }

            function showCountdown() {
                showOverlay('countdown-overlay', true);
                let count = 3;
                
                const updateCountdown = () => {
                    countdownText.classList.remove('countdown-zoom');
                    void countdownText.offsetWidth; // Trigger reflow
                    countdownText.classList.add('countdown-zoom');

                    if (count > 0) {
                        countdownText.textContent = count;
                        setTimeout(() => {
                            count--;
                            updateCountdown();
                        }, 1000);
                    } else if (count === 0) {
                        countdownText.style.fontSize = '8rem';
                        countdownText.textContent = 'GO!';
                         setTimeout(async () => {
                            showOverlay('countdown-overlay', false);
                            countdownText.style.fontSize = '10rem';
                            if (onlineState.hostId === myPlayerId) {
                                const { db, doc, updateDoc } = window.firebase;
                                try {
                                    await updateDoc(doc(db, "matches", currentMatchId), { status: "playing" });
                                } catch(e) { console.error("Could not start match", e)}
                            }
                        }, 1000);
                    }
                };
                updateCountdown();
            }
            
            function renderMatchRoomSkeleton() {
                views.matchRoom.innerHTML = `<div id="match-room-container"><div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-800/80 backdrop-blur-sm p-3 rounded-lg border border-gray-700 mb-6"><h2 id="match-room-title" class="text-xl font-bold text-cyan-400">Memuat...</h2><div class="flex items-center gap-2"><span class="text-slate-400">Kode:</span><input type="text" id="match-id-display" readonly class="bg-gray-700 text-lime-400 font-mono p-1 rounded w-32 text-center"><button id="copy-match-id-btn" class="px-2 py-1 bg-gray-600 rounded hover:bg-gray-500"><i class="fa-solid fa-copy"></i></button></div></div><div id="player-progress-container" class="flex flex-col gap-3 mb-6"></div><div id="game-area-container"></div><div id="match-controls" class="flex justify-center items-center gap-4 mt-6"></div></div>`;
                 document.getElementById('copy-match-id-btn').addEventListener('click', () => {
                    const matchIdInput = document.getElementById('match-id-display');
                    matchIdInput.select();
                    document.execCommand('copy');
                    showToast('Kode pertandingan disalin!');
                });
            }

            function updateMatchRoomUI(data) {
                document.getElementById('match-room-title').textContent = `Ruang ${data.matchType.toUpperCase()}`;
                document.getElementById('match-id-display').value = currentMatchId;
                const progressContainer = document.getElementById('player-progress-container');
                
                const playerIds = Object.keys(data.players);
                playerIds.sort((a, b) => {
                    if (a === myPlayerId) return -1;
                    if (b === myPlayerId) return 1;
                    return data.players[a].name.localeCompare(data.players[b].name);
                });

                progressContainer.innerHTML = playerIds.map(pid => renderPlayerProgress(pid, data.players[pid], data.hostId, data.matchType, data.status)).join('');

                if (!localGameStarted) {
                    const gameAreaContainer = document.getElementById('game-area-container');
                    let gameAreaHTML = '';
                    const isHost = data.hostId === myPlayerId;

                    if (data.matchType === 'wpm') {
                        const langIdActive = data.language === 'id' ? 'active' : '';
                        const langEnActive = data.language === 'en' ? 'active' : '';
                        const hostLangSelector = isHost ? `
                            <div class="flex justify-center gap-2 mb-4">
                                <button data-lang="id" class="lang-select-btn mode-btn px-4 py-1 rounded ${langIdActive}">ID</button>
                                <button data-lang="en" class="lang-select-btn mode-btn px-4 py-1 rounded ${langEnActive}">EN</button>
                            </div>` : `<p class="text-center text-slate-400 mb-4">Bahasa: ${data.language.toUpperCase()}</p>`;
                        
                        gameAreaHTML = `${hostLangSelector}<div id="online-text-container" class="bg-gray-800/80 backdrop-blur-sm p-6 rounded-lg shadow-lg relative min-h-[140px] flex items-center border border-gray-700"><p id="online-text-display" class="text-2xl leading-relaxed tracking-wide text-slate-400 select-none">Menunggu host memulai pertandingan...</p><input id="online-input-field" type="text" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-default" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled></div>`;
                    } else { // CPS Match
                        const durations = [5, 10, 15, 20];
                        const hostCpsSelector = isHost ? `
                            <div class="flex justify-center gap-2 mb-4">
                                ${durations.map(d => `<button data-duration="${d}" class="cps-duration-select-btn mode-btn px-4 py-1 rounded ${data.cpsDuration === d ? 'active' : ''}">${d}s</button>`).join('')}
                            </div>` : `<p class="text-center text-slate-400 mb-4">Durasi: ${data.cpsDuration} detik</p>`;

                        gameAreaHTML = `${hostCpsSelector}<div id="online-click-area" class="w-full h-64 bg-gray-800/80 backdrop-blur-sm rounded-lg shadow-lg flex flex-col items-center justify-center text-center border-2 border-dashed border-cyan-500/50 relative overflow-hidden cursor-not-allowed"><p id="online-click-area-text" class="text-3xl font-bold text-white">Menunggu host memulai pertandingan...</p><p id="online-cps-timer-display" class="text-5xl font-black text-lime-400 mt-4">${data.cpsDuration}s</p></div>`;
                    }
                    gameAreaContainer.innerHTML = gameAreaHTML;
                    if (isHost) {
                        document.querySelectorAll('.lang-select-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const lang = e.target.dataset.lang;
                                const { db, doc, updateDoc } = window.firebase;
                                await updateDoc(doc(db, "matches", currentMatchId), { language: lang });
                            });
                        });
                        document.querySelectorAll('.cps-duration-select-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const duration = parseInt(e.target.dataset.duration, 10);
                                selectedCpsDuration = duration;
                                const { db, doc, updateDoc } = window.firebase;
                                await updateDoc(doc(db, "matches", currentMatchId), { cpsDuration: duration });
                            });
                        });
                    }
                }
                const controlsContainer = document.getElementById('match-controls');
                const isHost = data.hostId === myPlayerId;
                let controlsHTML = `<button id="leave-match-btn" class="px-6 py-3 bg-red-500 text-white font-bold rounded-md hover:bg-red-600">Keluar</button>`;
                if (isHost && data.status === 'waiting') {
                    controlsHTML = `<button id="start-match-btn" class="px-6 py-3 bg-lime-500 text-gray-900 font-bold rounded-md hover:bg-lime-600">Mulai Pertandingan</button>` + controlsHTML;
                }
                controlsContainer.innerHTML = controlsHTML;
                document.getElementById('leave-match-btn').addEventListener('click', () => leaveMatch(false));
                if (isHost && data.status === 'waiting') {
                    document.getElementById('start-match-btn').addEventListener('click', startMatch);
                }
            }
            
            function renderPlayerProgress(pid, player, hostId, matchType, status) {
                const isMe = pid === myPlayerId;
                const isHost = pid === hostId;
                const isRoomHost = myPlayerId === hostId;
                const devTagHTML = player.isDeveloper ? `<span class="dev-tag role-tag ml-2">Developer</span>` : '';
                const adminTagHTML = player.isAdmin ? `<span class="admin-tag role-tag ml-2">Admin</span>` : '';
                const kickBtnHTML = (isRoomHost && !isMe && status === 'waiting') ? `<button data-kick-id="${pid}" data-kick-name="${player.name}" class="kick-btn ml-auto text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded-md"><i class="fa-solid fa-user-slash"></i></button>` : '';

                return `<div class="p-3 rounded-lg ${isMe ? 'bg-cyan-900/50 border border-cyan-500' : 'bg-gray-700/50'}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold flex items-center ${isMe ? 'text-lime-400' : 'text-white'}">${player.name} ${isMe ? '(Anda)' : ''} ${isHost ? '<i class="fa-solid fa-crown text-yellow-400 ml-2" title="Host"></i>' : ''} ${devTagHTML} ${adminTagHTML} ${player.finished ? '<i class="fa-solid fa-check-circle text-green-400 ml-2"></i>' : ''}</span>
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-white">${player.score} ${matchType === 'wpm' ? 'WPM' : 'CPS'}</span>
                            ${kickBtnHTML}
                        </div>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-4 relative overflow-hidden">
                        <div class="progress-bar-inner bg-gradient-to-r from-cyan-500 to-lime-400 h-4 rounded-full" style="width: ${player.progress}%"></div>
                        <span class="absolute inset-0 flex items-center justify-center text-xs text-black font-bold" style="text-shadow: 0 0 2px white;">${Math.round(player.progress)}%</span>
                    </div>
                </div>`;
            }

            async function kickPlayer(playerIdToKick) {
                if (!currentMatchId) return;
                const { db, doc, runTransaction } = window.firebase;
                const matchDocRef = doc(db, "matches", currentMatchId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const matchDoc = await transaction.get(matchDocRef);
                        if (!matchDoc.exists()) return;
                        const data = matchDoc.data();
                        const newPlayers = { ...data.players };
                        delete newPlayers[playerIdToKick];
                        transaction.update(matchDocRef, { players: newPlayers });
                    });
                    showToast('Pemain telah dikeluarkan.', 'info');
                } catch (error) {
                    console.error("Gagal mengeluarkan pemain:", error);
                    showToast("Gagal mengeluarkan pemain.", "error");
                }
            }

            async function startMatch() {
                const { db, doc, updateDoc, getDoc } = window.firebase;
                const matchDocRef = doc(db, "matches", currentMatchId);
                const matchDoc = await getDoc(matchDocRef);
                const matchData = matchDoc.data();
                const textToType = matchData.matchType === 'wpm' ? textSamples[matchData.language][Math.floor(Math.random() * textSamples[matchData.language].length)] : '';
                await updateDoc(matchDocRef, { status: "starting", textToType });
            }
            
            function showResults(data) {
                if (unsubscribeFromMatch) { unsubscribeFromMatch(); unsubscribeFromMatch = null; }
                const { db, doc, deleteDoc } = window.firebase;
                
                const tableContainer = document.getElementById('results-table-container');
                const playersArray = Object.values(data.players);
                playersArray.sort((a, b) => b.score - a.score);
                const isWpmMatch = data.matchType === 'wpm';
                let tableHTML = `<table class="w-full text-left text-slate-300"><thead><tr class="border-b border-gray-600"><th class="p-2">#</th><th class="p-2">Pemain</th><th class="p-2 text-center">${isWpmMatch ? 'WPM' : 'CPS'}</th>${isWpmMatch ? '<th class="p-2 text-center">Akurasi</th>' : ''}<th class="p-2 text-center">Waktu</th></tr></thead><tbody>`;
                playersArray.forEach((p, index) => {
                    const devTagHTML = p.isDeveloper ? `<span class="dev-tag role-tag ml-2">Developer</span>` : '';
                    const adminTagHTML = p.isAdmin ? `<span class="admin-tag role-tag ml-2">Admin</span>` : '';
                    tableHTML += `<tr class="border-b border-gray-700 ${index === 0 ? 'bg-lime-500/10' : ''}"><td class="p-3 font-bold">${index === 0 ? '<i class="fa-solid fa-trophy text-yellow-400"></i>' : index + 1}</td><td class="p-3 font-semibold flex items-center">${p.name} ${devTagHTML}${adminTagHTML}</td><td class="p-3 text-center font-bold text-lime-400">${p.score}</td>${isWpmMatch ? `<td class="p-3 text-center">${p.accuracy}%</td>` : ''}<td class="p-3 text-center">${p.duration.toFixed(1)}s</td></tr>`;
                });
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
                showOverlay('results-modal', true);

                if (data.hostId === myPlayerId) {
                    setTimeout(() => {
                        deleteDoc(doc(db, "matches", currentMatchId)).catch(err => console.log("Gagal menghapus match, mungkin sudah dihapus."));
                    }, 15000);
                }
            }

            backToLobbyBtn.addEventListener('click', () => { 
                showOverlay('results-modal', false);
                leaveMatch(true); 
            });
            
            function setupDevCheatButton() {
                let cheatBtn = document.getElementById('dev-cheat-btn');
                if (!cheatBtn) {
                    cheatBtn = document.createElement('button');
                    cheatBtn.id = 'dev-cheat-btn';
                    document.body.appendChild(cheatBtn);
                }
                cheatBtn.innerHTML = cheatActive ? '<i class="fa-solid fa-bolt"></i> Cheat Aktif' : '<i class="fa-solid fa-bolt"></i> Aktifkan Cheat';
                cheatBtn.className = cheatActive ? 'active' : '';
                cheatBtn.disabled = false;
            }

            // ONLINE WPM GAME LOGIC
            function initializeOnlineWpmGame(data) {
                const textContainer = document.getElementById('online-text-display');
                const inputField = document.getElementById('online-input-field');
                if (!textContainer || !inputField) return;

                let cheatPendingActivation = false;
                let autoTypingInterval = null;
                const cheatBtn = document.getElementById('dev-cheat-btn');
                if (cheatBtn) {
                    cheatBtn.disabled = false; // Ensure button is enabled
                    cheatBtn.onclick = () => {
                        if (testFinished) return;
                        
                        cheatActive = !cheatActive;
                        cheatBtn.classList.toggle('active', cheatActive);

                        if (cheatActive) {
                            cheatPendingActivation = true;
                            cheatBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Menunggu...';
                            showToast(`Cheat disiapkan. Ketik 1 huruf benar untuk memulai.`);
                            inputField.disabled = false;
                            inputField.focus();
                            clearInterval(autoTypingInterval);
                            autoTypingInterval = null;
                        } else {
                            cheatPendingActivation = false;
                            cheatBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Aktifkan Cheat';
                            showToast(`Cheat dinonaktifkan.`);
                            clearInterval(autoTypingInterval);
                            autoTypingInterval = null;
                            inputField.disabled = false;
                            inputField.focus();
                        }
                    };
                }

                const text = data.textToType;
                textContainer.innerHTML = text.split('').map(char => `<span class="char-span">${char}</span>`).join('');
                inputField.disabled = false;
                let charSpans = Array.from(textContainer.children);
                if (charSpans.length > 0) { charSpans[0].classList.add('cursor', 'border-l-2', 'border-lime-400'); }
                let currentIndex = 0, errorCount = 0, startTime = null, testFinished = false;

                async function finishTest() {
                    if (testFinished) return;
                    testFinished = true;
                    clearInterval(autoTypingInterval);
                    autoTypingInterval = null;
                    inputField.blur();
                    inputField.disabled = true;
                    const duration = (new Date() - startTime) / 1000;
                    const correctChars = currentIndex - errorCount;
                    const wpm = (duration > 0 ? Math.round(((correctChars / 5) / (duration / 60))) : 0);
                    const accuracy = currentIndex > 0 ? Math.round((correctChars / currentIndex) * 100) : 100;
                    if (!currentMatchId) return;
                    const { db, doc, updateDoc } = window.firebase;
                    try {
                        await updateDoc(doc(db, "matches", currentMatchId), {
                            [`players.${myPlayerId}.score`]: wpm,
                            [`players.${myPlayerId}.progress`]: 100,
                            [`players.${myPlayerId}.finished`]: true,
                            [`players.${myPlayerId}.accuracy`]: accuracy,
                            [`players.${myPlayerId}.duration`]: duration,
                        });
                    } catch (e) { console.log("Gagal update progress akhir, mungkin match sudah selesai.")}
                }

                async function updateMyProgress() {
                    if (testFinished || !currentMatchId) return;
                    const progress = (currentIndex / text.length) * 100;
                    const elapsedTime = startTime ? (new Date() - startTime) / 1000 : 0;
                    const wpm = elapsedTime > 0 ? Math.round(((currentIndex - errorCount) / 5) / (elapsedTime / 60)) : 0;
                    const { db, doc, updateDoc } = window.firebase;
                    try {
                        await updateDoc(doc(db, "matches", currentMatchId), {
                            [`players.${myPlayerId}.score`]: wpm,
                            [`players.${myPlayerId}.progress`]: progress,
                        });
                    } catch (e) { console.log("Gagal update progress, mungkin match sudah selesai.")}
                }
                
                function startAutoTyping() {
                    if (autoTypingInterval) return; // Prevent multiple intervals
                    const wpm = 500; // Increased speed
                    const charsPerMinute = wpm * 5;
                    const delay = 60000 / charsPerMinute; 

                    autoTypingInterval = setInterval(() => {
                        if (testFinished || currentIndex >= text.length) {
                            clearInterval(autoTypingInterval);
                            autoTypingInterval = null;
                            if (!testFinished) finishTest();
                            return;
                        }
                        
                        if (!startTime) startTime = new Date();

                        const currentSpan = charSpans[currentIndex];
                        currentSpan.className = 'char-span char-correct';
                        currentSpan.classList.remove('cursor', 'border-l-2', 'border-lime-400');
                        currentIndex++;

                        if (currentIndex < text.length) {
                            charSpans[currentIndex].classList.add('cursor', 'border-l-2', 'border-lime-400');
                        }
                        
                        updateMyProgress();

                        if (currentIndex >= text.length) {
                            clearInterval(autoTypingInterval);
                            autoTypingInterval = null;
                            finishTest();
                        }
                    }, delay);
                }

                function handleInput(e) {
                    if (testFinished || currentIndex >= text.length || autoTypingInterval) return;
                    if (!startTime) startTime = new Date();
                    
                    const typedChar = e.target.value.slice(-1);
                    e.target.value = '';
                    const expectedChar = text[currentIndex];

                    if (cheatPendingActivation) {
                        if (typedChar === expectedChar) {
                            cheatPendingActivation = false;
                            inputField.disabled = true;
                            if(cheatBtn) cheatBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> Cheat Aktif';
                            
                            // Process this first correct character
                            const currentSpan = charSpans[currentIndex];
                            currentSpan.className = 'char-span char-correct';
                            currentSpan.classList.remove('cursor', 'border-l-2', 'border-lime-400');
                            currentIndex++;
                            if (currentIndex < text.length) {
                                charSpans[currentIndex].classList.add('cursor', 'border-l-2', 'border-lime-400');
                            }
                            updateMyProgress();
                            
                            // Start auto-typing for the rest
                            startAutoTyping();
                            return;
                        }
                    }
                    
                    const currentSpan = charSpans[currentIndex];
                    if (typedChar !== expectedChar) {
                        if (!currentSpan.classList.contains('char-incorrect')) { errorCount++; currentSpan.classList.add('char-incorrect'); }
                        return;
                    }
                    currentSpan.className = 'char-span char-correct';
                    currentSpan.classList.remove('cursor', 'border-l-2', 'border-lime-400');
                    currentIndex++;
                    if (currentIndex < text.length) {
                        charSpans[currentIndex].classList.add('cursor', 'border-l-2', 'border-lime-400');
                    } else {
                        finishTest();
                        return;
                    }
                    updateMyProgress();
                }
                
                function handleKeydown(e) {
                    if (testFinished || cheatActive) return;
                    if (e.key === 'Backspace' && currentIndex > 0) {
                        e.preventDefault();
                        if (currentIndex < text.length) { charSpans[currentIndex].classList.remove('cursor', 'border-l-2', 'border-lime-400'); }
                        currentIndex--;
                        charSpans[currentIndex].className = 'char-span';
                        charSpans[currentIndex].classList.add('cursor', 'border-l-2', 'border-lime-400');
                    }
                }
                
                inputField.addEventListener('input', handleInput);
                inputField.addEventListener('keydown', handleKeydown);
                inputField.focus();
            }
            
            // ONLINE CPS GAME LOGIC
            function initializeOnlineCpsGame(data) {
                const clickArea = document.getElementById('online-click-area');
                const timerDisplay = document.getElementById('online-cps-timer-display');
                const clickAreaText = document.getElementById('online-click-area-text');
                if (!clickArea || !timerDisplay) return;

                const cheatBtn = document.getElementById('dev-cheat-btn');
                if (cheatBtn) {
                    cheatBtn.disabled = true; // Cheat doesn't apply to CPS test
                }

                clickArea.classList.remove('cursor-not-allowed');
                clickArea.style.cursor = 'pointer';
                clickAreaText.textContent = 'KLIK SECEPATNYA!';
                
                let clickCount = 0, testFinished = false, timeLeft = data.cpsDuration;
                let startTime = Date.now();
                
                if (localCpsTimer) clearInterval(localCpsTimer);

                localCpsTimer = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = `${timeLeft}s`;
                    if (timeLeft <= 0) {
                        clearInterval(localCpsTimer);
                        if (!testFinished) finishTest();
                    }
                }, 1000);
                
                async function finishTest() {
                    if (testFinished) return;
                    testFinished = true;
                    clickArea.style.cursor = 'not-allowed';
                    clickAreaText.textContent = 'Waktu Habis!';

                    const duration = data.cpsDuration;
                    const cps = cheatActive ? 100 : clickCount / duration;
                    if (!currentMatchId) return;
                    const { db, doc, updateDoc } = window.firebase;
                    try {
                        await updateDoc(doc(db, "matches", currentMatchId), {
                            [`players.${myPlayerId}.score`]: parseFloat(cps.toFixed(2)),
                            [`players.${myPlayerId}.progress`]: 100,
                            [`players.${myPlayerId}.finished`]: true,
                            [`players.${myPlayerId}.accuracy`]: 100,
                            [`players.${myPlayerId}.duration`]: duration,
                        });
                    } catch(e) { console.log("Gagal update progress akhir, mungkin match sudah selesai.")}
                }

                async function updateMyProgress() {
                    if (testFinished || !currentMatchId) return;
                    const elapsedTime = (Date.now() - startTime) / 1000;
                    const progress = (elapsedTime / data.cpsDuration) * 100;
                    const currentCPS = elapsedTime > 0 ? clickCount / elapsedTime : 0;

                    const { db, doc, updateDoc } = window.firebase;
                     try {
                        await updateDoc(doc(db, "matches", currentMatchId), {
                            [`players.${myPlayerId}.score`]: parseFloat(currentCPS.toFixed(2)),
                            [`players.${myPlayerId}.progress`]: Math.min(100, progress),
                        });
                    } catch (e) { console.log("Gagal update progress, mungkin match sudah selesai.")}
                }

                clickArea.onclick = (e) => {
                    if(testFinished) return;
                    if(cheatActive) {
                        clickCount = data.cpsDuration * 100; // Set clicks to achieve 100 CPS
                        finishTest();
                        return;
                    }
                    clickCount++;
                    updateMyProgress();
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    clickArea.appendChild(ripple);
                    const rect = clickArea.getBoundingClientRect();
                    ripple.style.left = `${e.clientX - rect.left}px`;
                    ripple.style.top = `${e.clientY - rect.top}px`;
                    ripple.onanimationend = () => ripple.remove();
                };
            }
            
            // ATTACH LOBBY LISTENERS
            createWpmMatchBtn.addEventListener('click', () => createMatch('wpm'));
            createCpsMatchBtn.addEventListener('click', () => createMatch('cps'));
            joinRandomMatchBtn.addEventListener('click', joinRandomMatch);
            joinMatchBtn.addEventListener('click', () => joinMatch(joinMatchInput.value.trim()));
            joinMatchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') joinMatch(joinMatchInput.value.trim()); });
        });
    </script>
</body>
</html>